<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trader Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ─── RESET ─────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px;-webkit-font-smoothing:antialiased}

/* ─── TOKENS ─────────────────────────────────────────── */
:root{
  --bg:    #080808;
  --s1:    #101010;
  --s2:    #181818;
  --b1:    #202020;
  --b2:    #2e2e2e;
  --b3:    #3c3c3c;
  --dim:   #505050;
  --mid:   #787878;
  --body:  #b4b4b4;
  --main:  #e8e8e8;
  --white: #ffffff;
  --buy:   #ffffff;
  --sell:  #c8c8c8;
  --wait:  #606060;
  --sans:  'Archivo Narrow', sans-serif;
  --mono:  'JetBrains Mono', monospace;
  --hdr:   48px;
}

/* ─── BASE ───────────────────────────────────────────── */
body{
  font-family:var(--sans);
  background:var(--bg);
  color:var(--body);
  min-height:100vh;
}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b2)}

/* ─── HEADER ─────────────────────────────────────────── */
.hdr{
  height:var(--hdr);
  background:var(--s1);
  border-bottom:1px solid var(--b1);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 20px;
  position:sticky;top:0;z-index:100;
}
.logo{
  font-family:var(--mono);
  font-size:.95rem;
  font-weight:600;
  letter-spacing:.12em;
  color:var(--white);
}
.logo span{color:var(--mid);font-weight:300}

.nav{display:flex;gap:2px}
.nav-btn{
  font-family:var(--sans);
  font-size:.75rem;
  font-weight:600;
  letter-spacing:.06em;
  text-transform:uppercase;
  color:var(--dim);
  background:none;
  border:none;
  padding:6px 12px;
  cursor:pointer;
  transition:color .15s;
  border-bottom:2px solid transparent;
}
.nav-btn.active{color:var(--white);border-bottom-color:var(--white)}
.nav-btn:hover:not(.active){color:var(--body)}

/* ─── LAYOUT (sidebar on ≥ 768px) ────────────────────── */
.shell{
  display:grid;
  grid-template-columns:1fr;
  min-height:calc(100vh - var(--hdr));
}
@media(min-width:768px){
  .shell{grid-template-columns:280px 1fr}
}
@media(min-width:1024px){
  .shell{grid-template-columns:300px 1fr}
}

/* ─── SIDEBAR (controls) ─────────────────────────────── */
.sidebar{
  border-right:1px solid var(--b1);
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:0;
}
@media(min-width:768px){
  .sidebar{
    position:sticky;
    top:var(--hdr);
    height:calc(100vh - var(--hdr));
    overflow-y:auto;
  }
}

/* ─── MAIN CONTENT ───────────────────────────────────── */
.main{
  padding:20px;
  min-height:calc(100vh - var(--hdr));
}
@media(min-width:768px){.main{padding:24px 28px}}

/* ─── TAB PAGES ──────────────────────────────────────── */
.tab-content{display:none}
.tab-content.active{display:block}

/* ─── SECTION LABEL ──────────────────────────────────── */
.sec-label{
  font-family:var(--mono);
  font-size:.6rem;
  font-weight:500;
  letter-spacing:.14em;
  text-transform:uppercase;
  color:var(--dim);
  padding:16px 0 8px;
  border-bottom:1px solid var(--b1);
  margin-bottom:12px;
}
.sec-label:first-child{padding-top:0}

/* ─── FIELD ──────────────────────────────────────────── */
.field{margin-bottom:14px}
.field-label{
  font-size:.68rem;
  font-weight:600;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--dim);
  margin-bottom:5px;
}

/* ─── SELECT / INPUT ─────────────────────────────────── */
.ctrl-select,.ctrl-input{
  width:100%;
  background:var(--s2);
  border:1px solid var(--b1);
  color:var(--main);
  font-family:var(--sans);
  font-size:.9rem;
  font-weight:500;
  padding:8px 10px;
  outline:none;
  transition:border-color .15s;
  -moz-appearance:textfield;
  border-radius:2px;
}
.ctrl-select::-webkit-outer-spin-button,
.ctrl-select::-webkit-inner-spin-button{-webkit-appearance:none}
.ctrl-input::-webkit-outer-spin-button,
.ctrl-input::-webkit-inner-spin-button{-webkit-appearance:none}
.ctrl-select:focus,.ctrl-input:focus{border-color:var(--b3)}
.ctrl-select{
  cursor:pointer;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6' fill='%23505050'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 10px center;
  background-color:var(--s2);
  padding-right:30px;
}
.ctrl-select option{background:var(--s1);color:var(--main)}
.ctrl-select optgroup{color:var(--dim);font-size:.8rem}

/* ─── BUTTON GROUPS ──────────────────────────────────── */
.btn-row{display:flex;flex-wrap:wrap;gap:4px}
.btn-chip{
  font-family:var(--mono);
  font-size:.68rem;
  font-weight:500;
  letter-spacing:.04em;
  background:var(--s2);
  border:1px solid var(--b1);
  color:var(--dim);
  padding:5px 9px;
  cursor:pointer;
  transition:all .12s;
  border-radius:2px;
}
.btn-chip.active{
  background:var(--b2);
  border-color:var(--b3);
  color:var(--white);
}
.btn-chip:hover:not(.active){border-color:var(--b2);color:var(--body)}

/* ─── ACTION BUTTON ──────────────────────────────────── */
.btn-action{
  width:100%;
  margin-top:auto;
  padding:11px;
  background:var(--white);
  border:none;
  color:var(--bg);
  font-family:var(--sans);
  font-size:.85rem;
  font-weight:700;
  letter-spacing:.1em;
  text-transform:uppercase;
  cursor:pointer;
  transition:background .15s,opacity .15s;
  border-radius:2px;
  margin-top:20px;
}
.btn-action:hover{background:var(--main)}
.btn-action:disabled{opacity:.35;cursor:not-allowed}

/* ─── LOADING ─────────────────────────────────────────── */
.loading{
  padding:32px 0;
  display:flex;
  flex-direction:column;
  gap:10px;
  color:var(--mid);
  font-family:var(--mono);
  font-size:.72rem;
}
.loading-row{display:flex;align-items:center;gap:8px}
.sp{
  width:12px;height:12px;
  border:1px solid var(--b2);
  border-top-color:var(--mid);
  border-radius:50%;
  animation:spin .7s linear infinite;
  flex-shrink:0;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ─── EMPTY STATE ─────────────────────────────────────── */
.empty{
  padding:48px 0;
  text-align:center;
  color:var(--dim);
  font-size:.8rem;
  line-height:1.8;
}
.empty-icon{font-size:1.6rem;margin-bottom:8px;display:block;opacity:.3}

/* ─── RESULT BLOCK ───────────────────────────────────── */
.result{}

/* Signal */
.sig-block{
  padding-bottom:16px;
  margin-bottom:16px;
  border-bottom:1px solid var(--b1);
}
.sig-pair{
  font-family:var(--mono);
  font-size:.62rem;
  letter-spacing:.1em;
  color:var(--dim);
  text-transform:uppercase;
  margin-bottom:8px;
}
.sig-main-row{
  display:flex;
  align-items:flex-end;
  gap:20px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.sig-val{
  font-family:var(--mono);
  font-size:2.2rem;
  font-weight:600;
  line-height:1;
  letter-spacing:-.02em;
}
.sig-val.buy {color:var(--white)}
.sig-val.sell{color:var(--sell)}
.sig-val.wait{color:var(--wait)}
.sig-score-wrap{display:flex;flex-direction:column;gap:4px;padding-bottom:4px}
.sig-score-txt{
  font-family:var(--mono);
  font-size:.62rem;
  color:var(--dim);
  letter-spacing:.06em;
}
.sig-bar{height:2px;background:var(--b1);width:160px;border-radius:1px;overflow:hidden}
.sig-bar-fill{height:100%;background:var(--white);transition:width .5s ease;border-radius:1px}
.sig-force{font-family:var(--mono);font-size:.58rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase}

/* Data table */
.data-table{
  width:100%;
  border-collapse:collapse;
  margin-bottom:16px;
}
.data-table td{
  padding:7px 0;
  border-bottom:1px solid var(--b1);
  font-size:.82rem;
}
.data-table td:first-child{
  font-family:var(--mono);
  font-size:.6rem;
  letter-spacing:.08em;
  text-transform:uppercase;
  color:var(--dim);
  width:100px;
}
.data-table td:last-child{
  font-family:var(--mono);
  font-weight:500;
  color:var(--main);
  text-align:right;
}
.data-table tr:last-child td{border-bottom:none}
.v-w{color:var(--white)!important}
.v-g{color:#a0a0a0!important}
.v-d{color:var(--dim)!important}

/* Plan block */
.plan-block{
  border:1px solid var(--b1);
  padding:14px;
  margin-bottom:16px;
  border-radius:2px;
}
.plan-hdr{
  display:flex;
  align-items:baseline;
  justify-content:space-between;
  margin-bottom:14px;
  padding-bottom:10px;
  border-bottom:1px solid var(--b1);
  flex-wrap:wrap;
  gap:8px;
}
.plan-lot-num{
  font-family:var(--mono);
  font-size:2.8rem;
  font-weight:600;
  color:var(--white);
  line-height:1;
  letter-spacing:-.04em;
  animation:pop .35s ease;
}
@keyframes pop{0%{transform:scale(.92);opacity:0}100%{transform:scale(1);opacity:1}}
.plan-lot-label{
  font-family:var(--mono);
  font-size:.58rem;
  letter-spacing:.1em;
  color:var(--dim);
  text-transform:uppercase;
  margin-top:3px;
}
.plan-rr{
  font-family:var(--mono);
  font-size:.75rem;
  font-weight:600;
  padding:4px 10px;
  border:1px solid var(--b2);
  color:var(--main);
  border-radius:2px;
  align-self:flex-end;
}

.level-row{
  display:grid;
  grid-template-columns:70px 1fr 1fr;
  gap:8px;
  align-items:center;
  padding:5px 0;
  border-bottom:1px solid var(--b1);
  font-size:.8rem;
}
.level-row:last-child{border-bottom:none}
.level-tag{
  font-family:var(--mono);
  font-size:.58rem;
  letter-spacing:.08em;
  color:var(--dim);
  text-transform:uppercase;
}
.level-price{font-family:var(--mono);font-weight:500;color:var(--main);text-align:center}
.level-info{font-family:var(--mono);font-size:.68rem;color:var(--mid);text-align:right}

/* Log items */
.log-block{margin-bottom:14px}
.log-title{
  font-family:var(--mono);
  font-size:.58rem;
  letter-spacing:.12em;
  color:var(--dim);
  text-transform:uppercase;
  margin-bottom:6px;
  padding-bottom:4px;
  border-bottom:1px solid var(--b1);
}
.log-item{
  font-size:.78rem;
  color:var(--body);
  padding:4px 0 4px 12px;
  position:relative;
  line-height:1.5;
  border-bottom:1px solid var(--b1);
}
.log-item:last-child{border-bottom:none}
.log-item::before{position:absolute;left:0;color:var(--dim)}
.log-item.ok::before{content:'+';color:var(--mid)}
.log-item.warn::before{content:'!';color:var(--mid)}
.log-item.warn{color:var(--mid)}

/* Advice */
.advice{
  padding:12px;
  background:var(--s1);
  border-left:2px solid var(--b3);
  margin-bottom:14px;
}
.advice-tag{
  font-family:var(--mono);
  font-size:.56rem;
  letter-spacing:.12em;
  color:var(--dim);
  text-transform:uppercase;
  margin-bottom:5px;
}
.advice-txt{font-size:.8rem;color:var(--body);line-height:1.6;font-style:italic}

/* Error */
.err{
  padding:12px;
  background:var(--s2);
  border-left:2px solid var(--b3);
  font-family:var(--mono);
  font-size:.72rem;
  color:var(--mid);
  line-height:1.7;
}
.err strong{color:var(--main);font-weight:600}

/* ─── SCANNER ─────────────────────────────────────────── */
.scan-prog{padding:32px 0;font-family:var(--mono);font-size:.7rem;color:var(--mid)}
.scan-prog-bar-bg{height:1px;background:var(--b1);margin:8px 0;position:relative;overflow:hidden}
.scan-prog-bar-fill{position:absolute;top:0;left:0;height:100%;background:var(--white);transition:width .3s}
.scan-prog-label{color:var(--dim);letter-spacing:.04em}

.scan-sum{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  border:1px solid var(--b1);
  margin-bottom:20px;
  border-radius:2px;
}
.scan-sum-cell{padding:14px 10px;text-align:center;border-right:1px solid var(--b1)}
.scan-sum-cell:last-child{border-right:none}
.scan-sum-num{
  font-family:var(--mono);
  font-size:1.8rem;
  font-weight:600;
  color:var(--white);
  line-height:1;
}
.scan-sum-label{
  font-family:var(--mono);
  font-size:.56rem;
  letter-spacing:.1em;
  color:var(--dim);
  text-transform:uppercase;
  margin-top:4px;
}

.scan-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:1px solid var(--b2)}
th{
  font-family:var(--mono);
  font-size:.58rem;
  font-weight:500;
  letter-spacing:.1em;
  text-transform:uppercase;
  color:var(--dim);
  padding:6px 8px;
  text-align:left;
}
th:not(:first-child){text-align:right}
td{
  font-family:var(--mono);
  font-size:.78rem;
  padding:7px 8px;
  border-bottom:1px solid var(--b1);
  color:var(--body);
}
td:not(:first-child){text-align:right}
tr.r-b td:first-child{border-left:2px solid var(--white)}
tr.r-s td:first-child{border-left:2px solid var(--b3)}
tr.r-w td:first-child{border-left:2px solid var(--b1);padding-left:6px}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="logo">TRADER<span>/PRO</span></div>
  <nav class="nav">
    <button class="nav-btn active" onclick="switchTab('analyser')">Analyse</button>
    <button class="nav-btn" onclick="switchTab('scanner')">Scanner</button>
  </nav>
</header>

<!-- ════ TAB ANALYSER ════ -->
<div class="tab-content active" id="tab-analyser">
<div class="shell">

  <!-- Sidebar controls -->
  <aside class="sidebar">
    <div class="sec-label">Instrument</div>

    <div class="field">
      <div class="field-label">Paire</div>
      <select id="pairSelect" class="ctrl-select">
        <optgroup label="Majeures">
          <option value="EURUSD=X">EUR/USD</option>
          <option value="GBPUSD=X" selected>GBP/USD</option>
          <option value="USDJPY=X">USD/JPY</option>
          <option value="USDCHF=X">USD/CHF</option>
          <option value="AUDUSD=X">AUD/USD</option>
          <option value="USDCAD=X">USD/CAD</option>
          <option value="NZDUSD=X">NZD/USD</option>
        </optgroup>
        <optgroup label="EUR Cross">
          <option value="EURGBP=X">EUR/GBP</option>
          <option value="EURJPY=X">EUR/JPY</option>
          <option value="EURAUD=X">EUR/AUD</option>
          <option value="EURCAD=X">EUR/CAD</option>
        </optgroup>
        <optgroup label="GBP Cross">
          <option value="GBPJPY=X">GBP/JPY</option>
          <option value="GBPAUD=X">GBP/AUD</option>
          <option value="GBPCAD=X">GBP/CAD</option>
        </optgroup>
        <optgroup label="Indices">
          <option value="^FCHI">CAC 40</option>
          <option value="^IXIC">NASDAQ</option>
          <option value="^GSPC">S&amp;P 500</option>
          <option value="^DJI">Dow Jones</option>
          <option value="^GDAXI">DAX</option>
        </optgroup>
        <optgroup label="Commodités">
          <option value="GC=F">Or / Gold</option>
          <option value="CL=F">Pétrole WTI</option>
        </optgroup>
      </select>
    </div>

    <div class="field">
      <div class="field-label">Timeframe</div>
      <div class="btn-row">
        <button class="btn-chip" data-tf="60m"  onclick="setTF(this,'60m')">1H</button>
        <button class="btn-chip active" data-tf="1d" onclick="setTF(this,'1d')">1J</button>
        <button class="btn-chip" data-tf="1wk"  onclick="setTF(this,'1wk')">1SEM</button>
        <button class="btn-chip" data-tf="1mo"  onclick="setTF(this,'1mo')">1MOIS</button>
      </div>
    </div>

    <div class="sec-label">Money Management</div>

    <div class="field">
      <div class="field-label">Capital (€)</div>
      <input type="number" id="capitalInput" class="ctrl-input" value="1000" min="1" step="100">
    </div>

    <div class="field">
      <div class="field-label">Risque / trade</div>
      <div class="btn-row">
        <button class="btn-chip" data-r="1"  onclick="setRisk(this,1)">1%</button>
        <button class="btn-chip" data-r="2"  onclick="setRisk(this,2)">2%</button>
        <button class="btn-chip" data-r="3"  onclick="setRisk(this,3)">3%</button>
        <button class="btn-chip" data-r="5"  onclick="setRisk(this,5)">5%</button>
        <button class="btn-chip active" data-r="10" onclick="setRisk(this,10)">10%</button>
        <button class="btn-chip" data-r="15" onclick="setRisk(this,15)">15%</button>
        <button class="btn-chip" data-r="20" onclick="setRisk(this,20)">20%</button>
        <button class="btn-chip" data-r="30" onclick="setRisk(this,30)">30%</button>
      </div>
    </div>

    <button class="btn-action" id="btnAnalyse" onclick="runAnalysis()">Analyser</button>
  </aside>

  <!-- Main results -->
  <main class="main">
    <div id="analysisResult">
      <div class="empty">
        <span class="empty-icon">◎</span>
        Sélectionne une paire et lance l'analyse
      </div>
    </div>
  </main>

</div>
</div>

<!-- ════ TAB SCANNER ════ -->
<div class="tab-content" id="tab-scanner">
<div class="shell">

  <aside class="sidebar">
    <div class="sec-label">Configuration</div>

    <div class="field">
      <div class="field-label">Timeframe</div>
      <div class="btn-row">
        <button class="btn-chip" data-stf="60m" onclick="setScanTF(this,'60m')">1H</button>
        <button class="btn-chip active" data-stf="1d" onclick="setScanTF(this,'1d')">1J</button>
        <button class="btn-chip" data-stf="1wk" onclick="setScanTF(this,'1wk')">1SEM</button>
        <button class="btn-chip" data-stf="1mo" onclick="setScanTF(this,'1mo')">1MOIS</button>
      </div>
    </div>

    <p style="font-size:.75rem;color:var(--dim);line-height:1.6;margin-bottom:16px">
      Analyse les 14 paires Forex majeures et affiche un classement par signal.
    </p>

    <button class="btn-action" id="btnScan" onclick="runScan()">Scanner</button>
  </aside>

  <main class="main">
    <div id="scanResult">
      <div class="empty">
        <span class="empty-icon">◎</span>
        Lance le scanner pour analyser toutes les paires
      </div>
    </div>
  </main>

</div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// CONSTANTES
// ═══════════════════════════════════════════════════════
const PAIR_INFO = {
  'EURUSD=X':{name:'EUR/USD',pipMult:10000,pipVal:8.50,dec:5},
  'GBPUSD=X':{name:'GBP/USD',pipMult:10000,pipVal:8.50,dec:5},
  'USDJPY=X':{name:'USD/JPY',pipMult:100,  pipVal:5.65,dec:3},
  'USDCHF=X':{name:'USD/CHF',pipMult:10000,pipVal:7.90,dec:5},
  'AUDUSD=X':{name:'AUD/USD',pipMult:10000,pipVal:8.50,dec:5},
  'USDCAD=X':{name:'USD/CAD',pipMult:10000,pipVal:6.10,dec:5},
  'NZDUSD=X':{name:'NZD/USD',pipMult:10000,pipVal:8.50,dec:5},
  'EURGBP=X':{name:'EUR/GBP',pipMult:10000,pipVal:11.05,dec:5},
  'EURJPY=X':{name:'EUR/JPY',pipMult:100,  pipVal:5.50,dec:3},
  'EURAUD=X':{name:'EUR/AUD',pipMult:10000,pipVal:6.00,dec:5},
  'EURCAD=X':{name:'EUR/CAD',pipMult:10000,pipVal:6.00,dec:5},
  'GBPJPY=X':{name:'GBP/JPY',pipMult:100,  pipVal:5.50,dec:3},
  'GBPAUD=X':{name:'GBP/AUD',pipMult:10000,pipVal:5.95,dec:5},
  'GBPCAD=X':{name:'GBP/CAD',pipMult:10000,pipVal:5.95,dec:5},
  '^FCHI'   :{name:'CAC 40', pipMult:1,    pipVal:0.93,dec:2},
  '^IXIC'   :{name:'NASDAQ', pipMult:1,    pipVal:0.93,dec:2},
  '^GSPC'   :{name:'S&P 500',pipMult:1,    pipVal:0.93,dec:2},
  '^DJI'    :{name:'Dow Jones',pipMult:1,  pipVal:0.93,dec:2},
  '^GDAXI'  :{name:'DAX',    pipMult:1,    pipVal:0.93,dec:2},
  'GC=F'    :{name:'Or/Gold',pipMult:100,  pipVal:0.93,dec:2},
  'CL=F'    :{name:'Pétrole',pipMult:100,  pipVal:0.93,dec:2},
};
const FOREX_SCAN_PAIRS = ['EURUSD=X','GBPUSD=X','USDJPY=X','USDCHF=X','AUDUSD=X','USDCAD=X','NZDUSD=X','EURGBP=X','EURJPY=X','EURAUD=X','EURCAD=X','GBPJPY=X','GBPAUD=X','GBPCAD=X'];
const RANGE_MAP = {'60m':'60d','1d':'1y','1wk':'5y','1mo':'10y'};
const CONSEILS = {
  ACHAT:   ["La tendance est ton amie. Achète dans le sens du marché.","Signal d'achat confirmé. Pose ton stop-loss et laisse le trade travailler.","Le marché monte. Entre avec discipline et respecte ton plan."],
  VENTE:   ["La tendance est baissière. Vends dans le sens du courant.","Signal de vente confirmé. Définis ton risque avant tout.","Le marché baisse. Suis la tendance, c'est ta meilleure alliée."],
  ATTENDRE:["Pas de signal clair. Le trader gagnant sait aussi NE PAS trader.","Patience. Attendre un bon setup vaut mieux que trader n'importe comment.","Le marché n'est pas clair. Préserve ton capital."],
};

// ═══════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════
let state = {tf:'1d', scanTf:'1d', riskPct:10};

function setTF(btn,tf){
  state.tf=tf;
  document.querySelectorAll('#tab-analyser .btn-chip[data-tf]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function setScanTF(btn,tf){
  state.scanTf=tf;
  document.querySelectorAll('#tab-scanner .btn-chip[data-stf]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function setRisk(btn,r){
  state.riskPct=r;
  document.querySelectorAll('.btn-chip[data-r]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function switchTab(name){
  document.querySelectorAll('.nav-btn').forEach((b,i)=>b.classList.toggle('active',['analyser','scanner'][i]===name));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}

// ═══════════════════════════════════════════════════════
// FETCH — robuste avec timeout manuel et 3 tentatives
// ═══════════════════════════════════════════════════════
function fetchWithTimeout(url, ms=20000){
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), ms);
  return fetch(url, {signal:ctrl.signal}).finally(()=>clearTimeout(id));
}

async function fetchCandles(symbol, interval, range){
  const base = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}&includePrePost=false`;
  const base2= `https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}&includePrePost=false`;

  const attempts = [
    // Tentative directe (marche parfois sans proxy)
    ()=>fetchWithTimeout(base, 8000),
    ()=>fetchWithTimeout(base2, 8000),
    // Via proxy 1
    ()=>fetchWithTimeout(`https://corsproxy.io/?url=${encodeURIComponent(base)}`, 20000),
    // Via proxy 2
    ()=>fetchWithTimeout(`https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`, 20000),
    // Via proxy 3
    ()=>fetchWithTimeout(`https://thingproxy.freeboard.io/fetch/${base}`, 20000),
  ];

  let lastErr = 'Toutes les tentatives ont échoué';
  for(const attempt of attempts){
    try{
      const res = await attempt();
      if(!res.ok){ lastErr=`HTTP ${res.status}`; continue; }
      const json = await res.json();
      const result = json?.chart?.result?.[0];
      if(!result?.timestamp){ lastErr='Format inattendu'; continue; }
      const ts=result.timestamp, q=result.indicators.quote[0];
      const candles=[];
      for(let i=0;i<ts.length;i++){
        if(q.close[i]!=null&&q.open[i]!=null&&q.high[i]!=null&&q.low[i]!=null)
          candles.push({t:ts[i]*1000,o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i]});
      }
      if(candles.length<50){ lastErr=`Données insuffisantes (${candles.length} bougies)`; continue; }
      return candles;
    }catch(e){
      lastErr = e.name==='AbortError'?'Délai dépassé — serveur trop lent':e.message;
    }
  }
  throw new Error(lastErr);
}

// ═══════════════════════════════════════════════════════
// INDICATEURS TECHNIQUES
// ═══════════════════════════════════════════════════════
function sma(arr,n){
  const r=new Array(arr.length).fill(null);
  for(let i=n-1;i<arr.length;i++){let s=0;for(let j=0;j<n;j++)s+=arr[i-j];r[i]=s/n;}
  return r;
}
function ema(arr,n){
  const k=2/(n+1),r=new Array(arr.length).fill(null);
  let s=0;for(let i=0;i<n;i++)s+=arr[i];r[n-1]=s/n;
  for(let i=n;i<arr.length;i++)r[i]=arr[i]*k+r[i-1]*(1-k);
  return r;
}
function calcRSI(closes,n=14){
  const r=new Array(closes.length).fill(null);
  if(closes.length<n+1)return r;
  let aG=0,aL=0;
  for(let i=1;i<=n;i++){const d=closes[i]-closes[i-1];if(d>0)aG+=d;else aL-=d;}
  aG/=n;aL/=n;r[n]=aL===0?100:100-100/(1+aG/aL);
  for(let i=n+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    aG=(aG*(n-1)+Math.max(0,d))/n;aL=(aL*(n-1)+Math.max(0,-d))/n;
    r[i]=aL===0?100:100-100/(1+aG/aL);
  }
  return r;
}
function calcMACD(closes,fast=12,slow=26,sig=9){
  const eF=ema(closes,fast),eS=ema(closes,slow);
  const ml=closes.map((_,i)=>eF[i]!=null&&eS[i]!=null?eF[i]-eS[i]:null);
  const sl=new Array(closes.length).fill(null);
  const fi=ml.findIndex(v=>v!=null);
  if(fi>=0&&fi+sig<closes.length){
    let s=0;for(let i=fi;i<fi+sig;i++)s+=ml[i];sl[fi+sig-1]=s/sig;
    const k=2/(sig+1);for(let i=fi+sig;i<closes.length;i++)sl[i]=ml[i]*k+sl[i-1]*(1-k);
  }
  const hist=closes.map((_,i)=>ml[i]!=null&&sl[i]!=null?ml[i]-sl[i]:null);
  return{ml,sl,hist};
}
function calcATR(highs,lows,closes,n=14){
  const r=new Array(closes.length).fill(null),tr=new Array(closes.length).fill(null);
  for(let i=1;i<closes.length;i++)
    tr[i]=Math.max(highs[i]-lows[i],Math.abs(highs[i]-closes[i-1]),Math.abs(lows[i]-closes[i-1]));
  let s=0;for(let i=1;i<=n;i++)s+=tr[i];r[n]=s/n;
  for(let i=n+1;i<closes.length;i++)r[i]=(r[i-1]*(n-1)+tr[i])/n;
  return r;
}

// ═══════════════════════════════════════════════════════
// CERVEAU DU TRADER
// ═══════════════════════════════════════════════════════
function traderBrain(symbol,candles,capital,riskPct){
  const info=PAIR_INFO[symbol]||{pipMult:10000,pipVal:8.5,dec:5};
  const closes=candles.map(c=>c.c),highs=candles.map(c=>c.h),lows=candles.map(c=>c.l);
  const n=closes.length;
  const ma20a=sma(closes,20),ma50a=sma(closes,50),ma200a=sma(closes,200);
  const rsiA=calcRSI(closes,14);
  const{ml:macdL,sl:macdS,hist:macdH}=calcMACD(closes);
  const atrA=calcATR(highs,lows,closes,14);
  const price=closes[n-1],ma20=ma20a[n-1],ma50=ma50a[n-1],ma200=ma200a[n-1];
  const rsiV=rsiA[n-1],macdV=macdL[n-1],macdSV=macdS[n-1],macdHV=macdH[n-1],atrV=atrA[n-1];
  if(!ma200||!rsiV||!macdV||!atrV)
    return{signal:'ATTENDRE',score:0,reasons:['Données insuffisantes (200 bougies minimum)'],warnings:[],price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt:null};
  const ma20slice=ma20a.slice(Math.max(0,n-5)).filter(v=>v!=null);
  const slopeMa20=ma20slice.length>=2?(ma20slice[ma20slice.length-1]-ma20slice[0])/ma20slice[0]*100:0;
  let direction;
  if(ma20>ma50&&slopeMa20>0)direction='HAUSSE';
  else if(ma20<ma50&&slopeMa20<0)direction='BAISSE';
  else direction='NEUTRE';
  let score=0;const reasons=[],warnings=[];
  if(direction==='HAUSSE'){
    score+=25;reasons.push('Tendance haussière confirmée — MA20 > MA50');
    if(ma50<ma200)warnings.push('MA50 sous MA200 — tendance de fond baissière');
    else{score+=15;reasons.push('Tendance long terme haussière — MA50 > MA200');}
    if(slopeMa20>0.05){score+=10;reasons.push('Pente MA20 positive — accélération haussière');}
  }else if(direction==='BAISSE'){
    score+=25;reasons.push('Tendance baissière confirmée — MA20 < MA50');
    if(ma50>ma200)warnings.push('MA50 au-dessus MA200 — tendance de fond haussière');
    else{score+=15;reasons.push('Tendance long terme baissière — MA50 < MA200');}
    if(slopeMa20<-0.05){score+=10;reasons.push('Pente MA20 négative — accélération baissière');}
  }else warnings.push('Tendance neutre — pas de direction claire');
  if(direction==='HAUSSE'){
    if(rsiV>=45&&rsiV<=60){score+=20;reasons.push(`RSI favorable achat (${rsiV.toFixed(1)})`);}
    else if(rsiV<=30){score+=15;reasons.push(`RSI en survente (${rsiV.toFixed(1)}) — rebond possible`);}
    else if(rsiV>=70){score-=10;warnings.push(`RSI en surachat (${rsiV.toFixed(1)}) — risque de correction`);}
  }else if(direction==='BAISSE'){
    if(rsiV>=40&&rsiV<=55){score+=20;reasons.push(`RSI favorable vente (${rsiV.toFixed(1)})`);}
    else if(rsiV>=70){score+=15;reasons.push(`RSI en surachat (${rsiV.toFixed(1)}) — baisse possible`);}
    else if(rsiV<=30){score-=10;warnings.push(`RSI en survente (${rsiV.toFixed(1)}) — risque de rebond`);}
  }
  const macdBull=macdV>macdSV&&macdHV>0,macdBear=macdV<macdSV&&macdHV<0;
  if(direction==='HAUSSE'&&macdBull){score+=20;reasons.push('MACD haussier — momentum confirmé');}
  else if(direction==='BAISSE'&&macdBear){score+=20;reasons.push('MACD baissier — momentum confirmé');}
  else warnings.push('MACD non aligné avec la tendance');
  if(direction==='HAUSSE'&&price>ma50){score+=10;reasons.push('Prix au-dessus MA50 — zone haussière');}
  else if(direction==='BAISSE'&&price<ma50){score+=10;reasons.push('Prix sous MA50 — zone baissière');}
  score=Math.max(0,Math.min(100,score));
  let signal;
  if(score>=60&&direction==='HAUSSE')signal='ACHAT';
  else if(score>=60&&direction==='BAISSE')signal='VENTE';
  else{signal='ATTENDRE';reasons.push(`Score insuffisant (${score}/100)`);}
  let riskMgmt=null;
  if(signal!=='ATTENDRE'){
    const slDist=atrV*1.5,tp1Dist=atrV*2.5,tp2Dist=atrV*4.0;
    const sl=signal==='ACHAT'?price-slDist:price+slDist;
    const tp1=signal==='ACHAT'?price+tp1Dist:price-tp1Dist;
    const tp2=signal==='ACHAT'?price+tp2Dist:price-tp2Dist;
    const slPips=Math.abs(price-sl)*info.pipMult;
    const tp1Pips=Math.abs(price-tp1)*info.pipMult;
    const tp2Pips=Math.abs(price-tp2)*info.pipMult;
    const rr=tp1Pips/slPips;
    if(rr<2.0){warnings.push(`Ratio R/R insuffisant (1:${rr.toFixed(1)}) — minimum 1:2`);signal='ATTENDRE';}
    else{
      const riskEur=capital*riskPct/100;
      const lots=Math.floor((riskEur/(slPips*info.pipVal))*100)/100;
      const realRisk=slPips*info.pipVal*lots;
      riskMgmt={
        entry:price.toFixed(info.dec),sl:sl.toFixed(info.dec),
        tp1:tp1.toFixed(info.dec),tp2:tp2.toFixed(info.dec),
        slPips:slPips.toFixed(1),tp1Pips:tp1Pips.toFixed(1),tp2Pips:tp2Pips.toFixed(1),
        lots:lots.toFixed(2),rr:rr.toFixed(2),
        riskEur:realRisk.toFixed(2),
        profit1:(tp1Pips*info.pipVal*lots).toFixed(2),
        profit2:(tp2Pips*info.pipVal*lots).toFixed(2),
      };
    }
  }
  const conseil=CONSEILS[signal][Math.floor(Math.random()*3)];
  return{signal,score,direction,slopeMa20,price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt,reasons,warnings,conseil};
}

// ═══════════════════════════════════════════════════════
// RENDER RESULT
// ═══════════════════════════════════════════════════════
function renderResult(res,symbol){
  const info=PAIR_INFO[symbol]||{name:symbol,dec:5};
  const d=info.dec;
  const sigCls=res.signal==='ACHAT'?'buy':res.signal==='VENTE'?'sell':'wait';
  const sigLbl=res.signal==='ACHAT'?'▲ ACHAT':res.signal==='VENTE'?'▼ VENTE':'◆ ATTENDRE';
  const forceLabel=res.score>=80?'FORT':res.score>=60?'MOYEN':'FAIBLE';
  const dirStr=res.direction==='HAUSSE'?'▲ HAUSSE':res.direction==='BAISSE'?'▼ BAISSE':'— NEUTRE';
  const macdSig=res.macdV>res.macdSV&&res.macdHV>0?'HAUSSIER':res.macdV<res.macdSV&&res.macdHV<0?'BAISSIER':'NEUTRE';
  const tf=state.tf;
  const now=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});

  let h='<div class="result">';

  // Signal
  h+=`
  <div class="sig-block">
    <div class="sig-pair">${info.name} &nbsp;·&nbsp; ${tf.toUpperCase()} &nbsp;·&nbsp; ${now}</div>
    <div class="sig-main-row">
      <div class="sig-val ${sigCls}">${sigLbl}</div>
      <div class="sig-score-wrap">
        <div class="sig-score-txt">Confiance &nbsp;${res.score}/100</div>
        <div class="sig-bar"><div class="sig-bar-fill" style="width:${res.score}%"></div></div>
        <div class="sig-force">Force &nbsp;${forceLabel}</div>
      </div>
    </div>
  </div>`;

  // Data table
  h+=`
  <table class="data-table">
    <tr><td>Prix</td><td class="v-w">${res.price?.toFixed(d)}</td></tr>
    <tr><td>Tendance</td><td>${dirStr}</td></tr>
    <tr><td>MA20</td><td>${res.ma20?.toFixed(d)}</td></tr>
    <tr><td>MA50</td><td>${res.ma50?.toFixed(d)}</td></tr>
    <tr><td>MA200</td><td class="v-g">${res.ma200?.toFixed(d)}</td></tr>
    <tr><td>RSI 14</td><td class="${res.rsiV>=70||res.rsiV<=30?'v-w':'v-g'}">${res.rsiV?.toFixed(1)}&nbsp;&nbsp;<span style="font-size:.65rem;color:var(--dim)">${res.rsiV>=70?'surachat':res.rsiV<=30?'survente':''}</span></td></tr>
    <tr><td>MACD</td><td class="${macdSig!=='NEUTRE'?'v-w':'v-g'}">${macdSig}</td></tr>
    <tr><td>ATR</td><td class="v-d">${res.atrV?.toFixed(d)}</td></tr>
  </table>`;

  // Plan
  if(res.riskMgmt){
    const rm=res.riskMgmt;
    const rrN=parseFloat(rm.rr);
    h+=`
  <div class="plan-block">
    <div class="plan-hdr">
      <div>
        <div class="plan-lot-num">${rm.lots}</div>
        <div class="plan-lot-label">Lots recommandés &nbsp;·&nbsp; ${rm.riskEur} €</div>
      </div>
      <div class="plan-rr">R/R &nbsp;1:${rm.rr}</div>
    </div>
    <div class="level-row">
      <span class="level-tag">Entrée</span>
      <span class="level-price" style="color:var(--white)">${rm.entry}</span>
      <span class="level-info">—</span>
    </div>
    <div class="level-row">
      <span class="level-tag">Stop Loss</span>
      <span class="level-price" style="color:var(--mid)">${rm.sl}</span>
      <span class="level-info">${rm.slPips} pips</span>
    </div>
    <div class="level-row">
      <span class="level-tag">TP 1</span>
      <span class="level-price" style="color:var(--white)">${rm.tp1}</span>
      <span class="level-info">+${rm.profit1} € &nbsp;${rm.tp1Pips}p</span>
    </div>
    <div class="level-row">
      <span class="level-tag">TP 2</span>
      <span class="level-price" style="color:var(--white)">${rm.tp2}</span>
      <span class="level-info">+${rm.profit2} € &nbsp;${rm.tp2Pips}p</span>
    </div>
  </div>`;
  }

  // Raisons
  if(res.reasons?.length){
    h+=`<div class="log-block"><div class="log-title">Raisons</div>`;
    res.reasons.forEach(r=>{h+=`<div class="log-item ok">${r}</div>`;});
    h+=`</div>`;
  }
  // Warnings
  if(res.warnings?.length){
    h+=`<div class="log-block"><div class="log-title">Avertissements</div>`;
    res.warnings.forEach(w=>{h+=`<div class="log-item warn">${w}</div>`;});
    h+=`</div>`;
  }
  // Conseil
  if(res.conseil){
    h+=`<div class="advice"><div class="advice-tag">Trader Pro</div><div class="advice-txt">${res.conseil}</div></div>`;
  }

  h+='</div>';
  return h;
}

// ═══════════════════════════════════════════════════════
// RUN ANALYSIS
// ═══════════════════════════════════════════════════════
async function runAnalysis(){
  const symbol=document.getElementById('pairSelect').value;
  const capital=parseFloat(document.getElementById('capitalInput').value)||1000;
  const btn=document.getElementById('btnAnalyse');
  const out=document.getElementById('analysisResult');
  btn.disabled=true;
  out.innerHTML=`<div class="loading"><div class="loading-row"><div class="sp"></div>Connexion au marché…</div></div>`;
  try{
    const range=RANGE_MAP[state.tf]||'1y';
    const candles=await fetchCandles(symbol,state.tf,range);
    out.querySelector('.loading').innerHTML='<div class="loading-row"><div class="sp"></div>Calcul des indicateurs…</div>';
    const result=traderBrain(symbol,candles,capital,state.riskPct);
    out.innerHTML=renderResult(result,symbol);
  }catch(e){
    out.innerHTML=`<div class="err"><strong>Erreur de connexion</strong><br>${e.message}<br><br>Si le problème persiste, réessaie dans quelques secondes — les APIs de données peuvent être temporairement surchargées.</div>`;
  }finally{
    btn.disabled=false;
  }
}

// ═══════════════════════════════════════════════════════
// RUN SCAN
// ═══════════════════════════════════════════════════════
async function runScan(){
  const btn=document.getElementById('btnScan');
  const out=document.getElementById('scanResult');
  const capital=1000;
  btn.disabled=true;
  const total=FOREX_SCAN_PAIRS.length;
  out.innerHTML=`<div class="scan-prog"><div class="scan-prog-label" id="pgLabel">Initialisation…</div><div class="scan-prog-bar-bg"><div class="scan-prog-bar-fill" id="pgBar" style="width:0%"></div></div></div>`;
  const results=[];
  for(let i=0;i<FOREX_SCAN_PAIRS.length;i++){
    const sym=FOREX_SCAN_PAIRS[i];
    document.getElementById('pgLabel').textContent=`${i+1} / ${total} — ${PAIR_INFO[sym]?.name||sym}`;
    document.getElementById('pgBar').style.width=Math.round((i+1)/total*100)+'%';
    try{
      const range=RANGE_MAP[state.scanTf]||'1y';
      const candles=await fetchCandles(sym,state.scanTf,range);
      const res=traderBrain(sym,candles,capital,2);
      results.push({sym,res});
    }catch(e){results.push({sym,res:null,err:e.message});}
    if(i<FOREX_SCAN_PAIRS.length-1)await delay(700);
  }
  results.sort((a,b)=>{
    const ord={ACHAT:0,VENTE:1,ATTENDRE:2};
    const sa=a.res?.signal||'ATTENDRE',sb=b.res?.signal||'ATTENDRE';
    if(ord[sa]!==ord[sb])return ord[sa]-ord[sb];
    return(b.res?.score||0)-(a.res?.score||0);
  });
  const nb_a=results.filter(r=>r.res?.signal==='ACHAT').length;
  const nb_v=results.filter(r=>r.res?.signal==='VENTE').length;
  const nb_w=results.filter(r=>r.res?.signal==='ATTENDRE'||!r.res).length;
  let html=`
  <div class="scan-sum">
    <div class="scan-sum-cell"><div class="scan-sum-num">${nb_a}</div><div class="scan-sum-label">Achat</div></div>
    <div class="scan-sum-cell"><div class="scan-sum-num">${nb_v}</div><div class="scan-sum-label">Vente</div></div>
    <div class="scan-sum-cell"><div class="scan-sum-num">${nb_w}</div><div class="scan-sum-label">Attendre</div></div>
  </div>
  <div class="scan-tbl-wrap"><table>
    <thead><tr><th>Paire</th><th>Signal</th><th>Score</th><th>Dir.</th><th>RSI</th></tr></thead>
    <tbody>`;
  results.forEach(({sym,res,err})=>{
    const info=PAIR_INFO[sym]||{name:sym};
    if(!res){html+=`<tr class="r-w"><td>${info.name}</td><td colspan="4" style="color:var(--dim);font-size:.65rem">${err||'Err'}</td></tr>`;return;}
    const sigStr=res.signal==='ACHAT'?`<span style="color:var(--white);font-weight:600">▲ ACHAT</span>`:res.signal==='VENTE'?`<span style="color:var(--sell)">▼ VENTE</span>`:`<span style="color:var(--dim)">◆</span>`;
    const dirStr=res.direction==='HAUSSE'?'▲':res.direction==='BAISSE'?'▼':'—';
    const rowCls=res.signal==='ACHAT'?'r-b':res.signal==='VENTE'?'r-s':'r-w';
    const sc=res.score>=70?'var(--white)':res.score>=50?'var(--mid)':'var(--dim)';
    html+=`<tr class="${rowCls}"><td style="font-weight:600;color:var(--main)">${info.name}</td><td>${sigStr}</td><td style="color:${sc};font-weight:600">${res.score}</td><td style="color:var(--mid)">${dirStr}</td><td style="color:var(--mid)">${res.rsiV?.toFixed(1)??'—'}</td></tr>`;
  });
  html+=`</tbody></table></div>`;
  out.innerHTML=html;
  btn.disabled=false;
}

function delay(ms){return new Promise(r=>setTimeout(r,ms));}
</script>
</body>
</html>
