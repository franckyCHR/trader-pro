<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TRADER PRO // TERMINAL</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@300;400;500;600;700&family=Rajdhani:wght@700&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════
   RESET & VARIABLES
═══════════════════════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

:root {
  --bg:      #060810;
  --bg1:     #090d1a;
  --bg2:     #0d1120;
  --line:    #131c30;
  --line2:   #1c2840;
  --cyan:    #00d4ff;
  --cyan-dim:rgba(0,212,255,0.08);
  --cyan-glo:rgba(0,212,255,0.25);
  --green:   #00ff94;
  --green-d: rgba(0,255,148,0.06);
  --red:     #ff2d55;
  --red-d:   rgba(255,45,85,0.06);
  --amber:   #ffad00;
  --amber-d: rgba(255,173,0,0.08);
  --text:    #b0c8e0;
  --bright:  #dceeff;
  --dim:     #2e4060;
  --dim2:    #1a2840;
  --mono:    'IBM Plex Mono', monospace;
  --logo:    'Rajdhani', sans-serif;
}

html { font-size:14px; -webkit-font-smoothing:antialiased; }

body {
  font-family: var(--mono);
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding-bottom: 60px;
  /* subtle dot grid */
  background-image:
    radial-gradient(circle, rgba(0,212,255,0.06) 1px, transparent 1px);
  background-size: 32px 32px;
  position: relative;
}

/* scanlines overlay */
body::after {
  content: '';
  position: fixed; inset: 0;
  background: repeating-linear-gradient(
    to bottom,
    transparent 0, transparent 3px,
    rgba(0,0,0,0.12) 3px, rgba(0,0,0,0.12) 4px
  );
  pointer-events: none;
  z-index: 9999;
}

/* ═══════════════════════════════════════════════════════
   SCROLLBAR
═══════════════════════════════════════════════════════ */
::-webkit-scrollbar { width:3px; height:3px }
::-webkit-scrollbar-track { background:var(--bg) }
::-webkit-scrollbar-thumb { background:var(--dim) }

/* ═══════════════════════════════════════════════════════
   HEADER
═══════════════════════════════════════════════════════ */
.t-header {
  position: sticky; top:0; z-index:100;
  background: var(--bg);
  border-bottom: 1px solid var(--line2);
  padding: 0 16px;
  display: flex;
  align-items: stretch;
  justify-content: space-between;
  height: 48px;
}

.t-logo {
  font-family: var(--logo);
  font-size: 1.3rem;
  font-weight: 700;
  letter-spacing: .18em;
  color: var(--bright);
  display: flex;
  align-items: center;
  gap: 6px;
}
.t-logo .accent { color: var(--cyan); text-shadow: 0 0 12px var(--cyan-glo); }
.t-logo .ver {
  font-family: var(--mono);
  font-size: .55rem;
  font-weight: 400;
  color: var(--dim);
  letter-spacing: .08em;
  align-self: flex-end;
  padding-bottom: 10px;
}
.cursor {
  display: inline-block;
  width: 8px; height: 14px;
  background: var(--cyan);
  margin-left: 2px;
  vertical-align: middle;
  animation: blink 1.1s steps(1) infinite;
  box-shadow: 0 0 8px var(--cyan);
}
@keyframes blink { 50%{ opacity:0 } }

.t-nav {
  display: flex;
  align-items: stretch;
  gap: 0;
}
.t-nav-btn {
  font-family: var(--mono);
  font-size: .68rem;
  font-weight: 500;
  letter-spacing: .1em;
  color: var(--dim);
  background: none;
  border: none;
  border-bottom: 2px solid transparent;
  padding: 0 12px;
  cursor: pointer;
  transition: all .15s;
}
.t-nav-btn.active {
  color: var(--cyan);
  border-bottom-color: var(--cyan);
  text-shadow: 0 0 10px var(--cyan-glo);
}
.t-nav-btn:hover:not(.active) { color: var(--text); }

/* ═══════════════════════════════════════════════════════
   LAYOUT
═══════════════════════════════════════════════════════ */
.t-main { max-width: 480px; margin: 0 auto; padding: 16px 12px; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* ═══════════════════════════════════════════════════════
   SECTION HEADINGS
═══════════════════════════════════════════════════════ */
.t-section {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 18px 0 10px;
}
.t-section::before {
  content: '//';
  color: var(--cyan);
  font-size: .65rem;
  font-weight: 700;
  letter-spacing: .05em;
}
.t-section-label {
  font-size: .6rem;
  font-weight: 600;
  letter-spacing: .18em;
  text-transform: uppercase;
  color: var(--dim);
}
.t-section::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--line2);
}

/* ═══════════════════════════════════════════════════════
   TERMINAL ROWS (input rows)
═══════════════════════════════════════════════════════ */
.t-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
  border-bottom: 1px solid var(--line);
}
.t-row:last-child { border-bottom: none; }

.t-label {
  font-size: .6rem;
  font-weight: 600;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--dim);
  white-space: nowrap;
  min-width: 80px;
}
.t-label::after { content: ' ›'; color: var(--line2); }

/* SELECT */
.t-select {
  flex: 1;
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--line2);
  color: var(--bright);
  font-family: var(--mono);
  font-size: .82rem;
  font-weight: 500;
  padding: 3px 0;
  outline: none;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6' fill='%232e4060'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 4px center;
}
.t-select:focus { border-bottom-color: var(--cyan); }
.t-select option { background: #0d1120; color: var(--text); }
.t-select optgroup { color: var(--dim); font-size: .75rem; }

/* NUMBER INPUT */
.t-input {
  background: transparent;
  border: none;
  border-bottom: 1px solid var(--line2);
  color: var(--bright);
  font-family: var(--mono);
  font-size: .95rem;
  font-weight: 600;
  padding: 3px 0;
  width: 100px;
  outline: none;
  -moz-appearance: textfield;
}
.t-input::-webkit-outer-spin-button,
.t-input::-webkit-inner-spin-button { -webkit-appearance: none; }
.t-input:focus { border-bottom-color: var(--cyan); }
.t-unit {
  font-size: .6rem;
  letter-spacing: .1em;
  color: var(--dim);
  text-transform: uppercase;
}

/* ═══════════════════════════════════════════════════════
   BUTTON GROUPS (TF + RISK)
═══════════════════════════════════════════════════════ */
.btn-group { display: flex; gap: 4px; flex-wrap: wrap; flex: 1; }

.btn-tf, .btn-risk {
  font-family: var(--mono);
  font-size: .65rem;
  font-weight: 600;
  letter-spacing: .06em;
  background: transparent;
  border: 1px solid var(--line2);
  color: var(--dim);
  padding: 5px 8px;
  cursor: pointer;
  transition: all .12s;
  text-transform: uppercase;
}
.btn-tf.active, .btn-risk.active {
  background: var(--cyan-dim);
  border-color: var(--cyan);
  color: var(--cyan);
  text-shadow: 0 0 8px var(--cyan-glo);
}
.btn-tf:hover:not(.active), .btn-risk:hover:not(.active) {
  border-color: var(--dim);
  color: var(--text);
}

/* ═══════════════════════════════════════════════════════
   MAIN ACTION BUTTON
═══════════════════════════════════════════════════════ */
.t-btn-main {
  width: 100%;
  margin: 20px 0 0;
  padding: 13px;
  background: transparent;
  border: 1px solid var(--cyan);
  color: var(--cyan);
  font-family: var(--mono);
  font-size: .82rem;
  font-weight: 700;
  letter-spacing: .2em;
  text-transform: uppercase;
  cursor: pointer;
  transition: all .15s;
  position: relative;
  overflow: hidden;
}
.t-btn-main::before {
  content: '';
  position: absolute; inset: 0;
  background: var(--cyan-dim);
  transform: scaleX(0);
  transform-origin: left;
  transition: transform .2s;
}
.t-btn-main:hover::before { transform: scaleX(1); }
.t-btn-main:hover { text-shadow: 0 0 10px var(--cyan-glo); box-shadow: 0 0 16px rgba(0,212,255,0.15); }
.t-btn-main:disabled { opacity:.4; cursor:not-allowed; }
.t-btn-main:disabled::before { display:none; }
.t-btn-main span { position: relative; z-index: 1; }

/* ═══════════════════════════════════════════════════════
   LOADING STATE
═══════════════════════════════════════════════════════ */
.t-loading {
  padding: 30px 0;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 8px;
}
.t-loading-line {
  font-size: .7rem;
  color: var(--cyan);
  display: flex;
  align-items: center;
  gap: 8px;
}
.t-loading-line::before {
  content: '>';
  color: var(--dim);
}
.t-spinner {
  width: 10px; height: 10px;
  border: 1px solid var(--dim);
  border-top-color: var(--cyan);
  border-radius: 50%;
  animation: spin .6s linear infinite;
  display: inline-block;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ═══════════════════════════════════════════════════════
   RESULT OUTPUT — TERMINAL STYLE
═══════════════════════════════════════════════════════ */
.t-out { margin-top: 20px; }

/* Signal header */
.sig-header {
  padding: 14px 0 10px;
  border-top: 1px solid var(--line2);
  border-bottom: 1px solid var(--line2);
  margin-bottom: 12px;
}
.sig-meta {
  font-size: .58rem;
  letter-spacing: .12em;
  color: var(--dim);
  text-transform: uppercase;
  margin-bottom: 6px;
}
.sig-main {
  display: flex;
  align-items: baseline;
  gap: 16px;
  flex-wrap: wrap;
}
.sig-val {
  font-family: var(--logo);
  font-size: 2.4rem;
  font-weight: 700;
  letter-spacing: .08em;
  line-height: 1;
}
.sig-val.buy   { color: var(--green); text-shadow: 0 0 20px rgba(0,255,148,.4); }
.sig-val.sell  { color: var(--red);   text-shadow: 0 0 20px rgba(255,45,85,.4); }
.sig-val.wait  { color: var(--amber); text-shadow: 0 0 20px rgba(255,173,0,.3); }

.sig-score-block { display: flex; flex-direction: column; gap: 4px; }
.sig-score-num {
  font-size: .65rem;
  letter-spacing: .08em;
  color: var(--dim);
}
.sig-bar-bg {
  width: 120px; height: 3px;
  background: var(--line2);
  position: relative;
}
.sig-bar-fg {
  position: absolute; top:0; left:0; height: 100%;
  transition: width .6s ease;
}
.sig-force {
  font-size: .6rem;
  letter-spacing: .12em;
  color: var(--dim);
  text-transform: uppercase;
  margin-top: 2px;
}

/* Data grid */
.t-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  margin-bottom: 12px;
  border: 1px solid var(--line);
}
.t-cell {
  padding: 9px 10px;
  border-right: 1px solid var(--line);
  border-bottom: 1px solid var(--line);
}
.t-cell:nth-child(even) { border-right: none; }
.t-cell:nth-last-child(-n+2) { border-bottom: none; }
.t-cell-label {
  font-size: .56rem;
  letter-spacing: .12em;
  text-transform: uppercase;
  color: var(--dim);
  margin-bottom: 3px;
}
.t-cell-val {
  font-size: .88rem;
  font-weight: 600;
  color: var(--bright);
}
.t-cell-sub {
  font-size: .58rem;
  color: var(--dim);
  margin-top: 2px;
}

/* Colors */
.v-cyan  { color: var(--cyan)!important;  text-shadow: 0 0 8px var(--cyan-glo); }
.v-green { color: var(--green)!important; }
.v-red   { color: var(--red)!important;   }
.v-amber { color: var(--amber)!important; }
.v-dim   { color: var(--dim)!important;   }

/* Trade plan block */
.t-plan {
  border: 1px solid var(--line2);
  padding: 12px;
  margin-bottom: 12px;
  position: relative;
}
.t-plan::before {
  content: '// PLAN DE TRADE';
  position: absolute;
  top: -8px; left: 10px;
  background: var(--bg);
  padding: 0 6px;
  font-size: .55rem;
  letter-spacing: .15em;
  color: var(--cyan);
  text-transform: uppercase;
}

.t-plan-lot {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--line);
}
.t-plan-lot-num {
  font-family: var(--logo);
  font-size: 2.8rem;
  font-weight: 700;
  color: var(--cyan);
  line-height: 1;
  text-shadow: 0 0 16px var(--cyan-glo);
  animation: lotPulse .4s ease;
}
@keyframes lotPulse { 0%{transform:scale(1)} 40%{transform:scale(1.05)} 100%{transform:scale(1)} }
.t-plan-lot-info { display: flex; flex-direction: column; gap: 3px; }
.t-plan-lot-label {
  font-size: .6rem; letter-spacing: .1em; text-transform: uppercase;
  color: var(--dim);
}
.t-plan-rr {
  font-size: .75rem; font-weight: 700;
  padding: 3px 8px;
  border: 1px solid;
  display: inline-block;
}
.t-plan-rr.good  { color: var(--green); border-color: var(--green); }
.t-plan-rr.ok    { color: var(--amber); border-color: var(--amber); }
.t-plan-rr.bad   { color: var(--red);   border-color: var(--red); }

.t-level {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 5px 0;
  border-bottom: 1px solid var(--line);
  font-size: .78rem;
}
.t-level:last-child { border-bottom: none; }
.t-level-tag {
  font-size: .58rem;
  letter-spacing: .1em;
  color: var(--dim);
  text-transform: uppercase;
  min-width: 60px;
}
.t-level-price { font-weight: 600; color: var(--bright); }
.t-level-pips  { font-size: .65rem; color: var(--dim); text-align: right; }
.t-level-profit{ font-size: .72rem; font-weight: 600; text-align: right; }

/* Reasons / Warnings */
.t-log {
  margin-bottom: 10px;
}
.t-log-title {
  font-size: .56rem;
  letter-spacing: .15em;
  color: var(--dim);
  text-transform: uppercase;
  margin-bottom: 6px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.t-log-title::after { content:''; flex:1; height:1px; background:var(--line); }
.t-log-item {
  font-size: .72rem;
  color: var(--text);
  padding: 3px 0 3px 14px;
  position: relative;
  line-height: 1.5;
}
.t-log-item::before {
  content: '›';
  position: absolute; left: 0;
  color: var(--dim);
}
.t-log-item.ok::before { content: '+'; color: var(--green); }
.t-log-item.warn { color: var(--amber); }
.t-log-item.warn::before { content: '!'; color: var(--amber); }

/* Advice */
.t-advice {
  padding: 12px 14px;
  border-left: 2px solid var(--cyan);
  background: var(--cyan-dim);
  margin-bottom: 10px;
}
.t-advice-tag {
  font-size: .55rem;
  letter-spacing: .15em;
  color: var(--cyan);
  text-transform: uppercase;
  margin-bottom: 5px;
}
.t-advice-text {
  font-size: .75rem;
  color: var(--text);
  line-height: 1.5;
  font-style: italic;
}

/* Error */
.t-error {
  padding: 12px 14px;
  border-left: 2px solid var(--red);
  background: var(--red-d);
  font-size: .72rem;
  color: var(--red);
  line-height: 1.6;
}

/* ═══════════════════════════════════════════════════════
   SCANNER
═══════════════════════════════════════════════════════ */
.scan-progress {
  padding: 20px 0;
}
.scan-prog-bar-bg {
  height: 2px;
  background: var(--line2);
  margin: 6px 0;
  position: relative;
  overflow: hidden;
}
.scan-prog-bar-fill {
  position: absolute; top:0; left:0; height:100%;
  background: var(--cyan);
  box-shadow: 0 0 8px var(--cyan);
  transition: width .3s;
}
.scan-prog-label {
  font-size: .62rem;
  color: var(--cyan);
  display: flex;
  align-items: center;
  gap: 6px;
}
.scan-prog-label::before { content: '>'; color: var(--dim); }

.scan-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  border: 1px solid var(--line);
  margin-bottom: 16px;
}
.scan-sum-cell {
  padding: 10px;
  text-align: center;
  border-right: 1px solid var(--line);
}
.scan-sum-cell:last-child { border-right: none; }
.scan-sum-num {
  font-family: var(--logo);
  font-size: 1.8rem;
  font-weight: 700;
  line-height: 1;
}
.scan-sum-label {
  font-size: .55rem;
  letter-spacing: .1em;
  color: var(--dim);
  text-transform: uppercase;
  margin-top: 3px;
}

/* Scan table */
.scan-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; }
thead tr { border-bottom: 1px solid var(--line2); }
th {
  font-family: var(--mono);
  font-size: .56rem;
  font-weight: 600;
  letter-spacing: .1em;
  text-transform: uppercase;
  color: var(--dim);
  padding: 6px 6px;
  text-align: left;
}
th:not(:first-child) { text-align: center; }
td {
  font-size: .72rem;
  padding: 7px 6px;
  border-bottom: 1px solid var(--line);
  color: var(--text);
  font-weight: 500;
}
td:not(:first-child) { text-align: center; }
tr.r-buy  td:first-child { border-left: 2px solid var(--green); }
tr.r-sell td:first-child { border-left: 2px solid var(--red); }
tr.r-wait td:first-child { border-left: 2px solid var(--dim2); }
tr:hover td { background: rgba(255,255,255,0.02); }
</style>
</head>
<body>

<!-- ═══════════ HEADER ═══════════ -->
<header class="t-header">
  <div class="t-logo">
    TRADER<span class="accent">&nbsp;PRO</span>
    <div class="cursor"></div>
    <span class="ver">v2.0</span>
  </div>
  <nav class="t-nav">
    <button class="t-nav-btn active" onclick="switchTab('analyser')">ANALYSE</button>
    <button class="t-nav-btn" onclick="switchTab('scanner')">SCANNER</button>
  </nav>
</header>

<main class="t-main">

<!-- ════════════════════════════════════════
     TAB — ANALYSER
════════════════════════════════════════ -->
<div class="tab-content active" id="tab-analyser">

  <div class="t-section"><span class="t-section-label">Instrument</span></div>

  <div class="t-row">
    <span class="t-label">Paire</span>
    <select id="pairSelect" class="t-select">
      <optgroup label="Majeures">
        <option value="EURUSD=X">EUR/USD</option>
        <option value="GBPUSD=X" selected>GBP/USD</option>
        <option value="USDJPY=X">USD/JPY</option>
        <option value="USDCHF=X">USD/CHF</option>
        <option value="AUDUSD=X">AUD/USD</option>
        <option value="USDCAD=X">USD/CAD</option>
        <option value="NZDUSD=X">NZD/USD</option>
      </optgroup>
      <optgroup label="EUR Cross">
        <option value="EURGBP=X">EUR/GBP</option>
        <option value="EURJPY=X">EUR/JPY</option>
        <option value="EURAUD=X">EUR/AUD</option>
        <option value="EURCAD=X">EUR/CAD</option>
      </optgroup>
      <optgroup label="GBP Cross">
        <option value="GBPJPY=X">GBP/JPY</option>
        <option value="GBPAUD=X">GBP/AUD</option>
        <option value="GBPCAD=X">GBP/CAD</option>
      </optgroup>
      <optgroup label="Indices">
        <option value="^FCHI">CAC 40</option>
        <option value="^IXIC">NASDAQ</option>
        <option value="^GSPC">S&amp;P 500</option>
        <option value="^DJI">Dow Jones</option>
        <option value="^GDAXI">DAX</option>
      </optgroup>
      <optgroup label="Commodités">
        <option value="GC=F">Or / Gold</option>
        <option value="CL=F">Pétrole WTI</option>
      </optgroup>
    </select>
  </div>

  <div class="t-row">
    <span class="t-label">Timeframe</span>
    <div class="btn-group">
      <button class="btn-tf" data-tf="60m"  onclick="setTF(this,'60m')">1H</button>
      <button class="btn-tf active" data-tf="1d" onclick="setTF(this,'1d')">1J</button>
      <button class="btn-tf" data-tf="1wk"  onclick="setTF(this,'1wk')">1SEM</button>
      <button class="btn-tf" data-tf="1mo"  onclick="setTF(this,'1mo')">1MOIS</button>
    </div>
  </div>

  <div class="t-section"><span class="t-section-label">Money Management</span></div>

  <div class="t-row">
    <span class="t-label">Capital</span>
    <input type="number" id="capitalInput" class="t-input" value="1000" min="1" step="100">
    <span class="t-unit">EUR</span>
  </div>

  <div class="t-row" style="align-items:flex-start;padding-top:10px">
    <span class="t-label" style="padding-top:6px">Risque</span>
    <div class="btn-group">
      <button class="btn-risk" data-r="1"  onclick="setRisk(this,1)">1%</button>
      <button class="btn-risk" data-r="2"  onclick="setRisk(this,2)">2%</button>
      <button class="btn-risk" data-r="3"  onclick="setRisk(this,3)">3%</button>
      <button class="btn-risk" data-r="5"  onclick="setRisk(this,5)">5%</button>
      <button class="btn-risk active" data-r="10" onclick="setRisk(this,10)">10%</button>
      <button class="btn-risk" data-r="15" onclick="setRisk(this,15)">15%</button>
      <button class="btn-risk" data-r="20" onclick="setRisk(this,20)">20%</button>
      <button class="btn-risk" data-r="30" onclick="setRisk(this,30)">30%</button>
    </div>
  </div>

  <button class="t-btn-main" id="btnAnalyse" onclick="runAnalysis()">
    <span>▶&nbsp;&nbsp;LANCER L'ANALYSE</span>
  </button>

  <div id="analysisResult"></div>

</div><!-- /tab-analyser -->

<!-- ════════════════════════════════════════
     TAB — SCANNER
════════════════════════════════════════ -->
<div class="tab-content" id="tab-scanner">

  <div class="t-section"><span class="t-section-label">Configuration</span></div>

  <div class="t-row">
    <span class="t-label">Timeframe</span>
    <div class="btn-group">
      <button class="btn-tf" data-stf="60m" onclick="setScanTF(this,'60m')">1H</button>
      <button class="btn-tf active" data-stf="1d" onclick="setScanTF(this,'1d')">1J</button>
      <button class="btn-tf" data-stf="1wk" onclick="setScanTF(this,'1wk')">1SEM</button>
      <button class="btn-tf" data-stf="1mo" onclick="setScanTF(this,'1mo')">1MOIS</button>
    </div>
  </div>

  <button class="t-btn-main" id="btnScan" onclick="runScan()">
    <span>◈&nbsp;&nbsp;SCANNER LES 14 PAIRES FOREX</span>
  </button>

  <div id="scanResult"></div>

</div><!-- /tab-scanner -->

</main>

<script>
// ══════════════════════════════════════════════════════════════
// CONSTANTES
// ══════════════════════════════════════════════════════════════
const PAIR_INFO = {
  'EURUSD=X':{ name:'EUR/USD', pipMult:10000, pipVal:8.50, dec:5 },
  'GBPUSD=X':{ name:'GBP/USD', pipMult:10000, pipVal:8.50, dec:5 },
  'USDJPY=X':{ name:'USD/JPY', pipMult:100,   pipVal:5.65, dec:3 },
  'USDCHF=X':{ name:'USD/CHF', pipMult:10000, pipVal:7.90, dec:5 },
  'AUDUSD=X':{ name:'AUD/USD', pipMult:10000, pipVal:8.50, dec:5 },
  'USDCAD=X':{ name:'USD/CAD', pipMult:10000, pipVal:6.10, dec:5 },
  'NZDUSD=X':{ name:'NZD/USD', pipMult:10000, pipVal:8.50, dec:5 },
  'EURGBP=X':{ name:'EUR/GBP', pipMult:10000, pipVal:11.05,dec:5 },
  'EURJPY=X':{ name:'EUR/JPY', pipMult:100,   pipVal:5.50, dec:3 },
  'EURAUD=X':{ name:'EUR/AUD', pipMult:10000, pipVal:6.00, dec:5 },
  'EURCAD=X':{ name:'EUR/CAD', pipMult:10000, pipVal:6.00, dec:5 },
  'GBPJPY=X':{ name:'GBP/JPY', pipMult:100,   pipVal:5.50, dec:3 },
  'GBPAUD=X':{ name:'GBP/AUD', pipMult:10000, pipVal:5.95, dec:5 },
  'GBPCAD=X':{ name:'GBP/CAD', pipMult:10000, pipVal:5.95, dec:5 },
  '^FCHI':   { name:'CAC 40',  pipMult:1,     pipVal:0.93, dec:2 },
  '^IXIC':   { name:'NASDAQ',  pipMult:1,     pipVal:0.93, dec:2 },
  '^GSPC':   { name:'S&P 500', pipMult:1,     pipVal:0.93, dec:2 },
  '^DJI':    { name:'Dow Jones',pipMult:1,    pipVal:0.93, dec:2 },
  '^GDAXI':  { name:'DAX',     pipMult:1,     pipVal:0.93, dec:2 },
  'GC=F':    { name:'Or/Gold', pipMult:100,   pipVal:0.93, dec:2 },
  'CL=F':    { name:'Pétrole', pipMult:100,   pipVal:0.93, dec:2 },
};

const FOREX_SCAN_PAIRS = ['EURUSD=X','GBPUSD=X','USDJPY=X','USDCHF=X','AUDUSD=X','USDCAD=X','NZDUSD=X','EURGBP=X','EURJPY=X','EURAUD=X','EURCAD=X','GBPJPY=X','GBPAUD=X','GBPCAD=X'];
const RANGE_MAP = { '60m':'60d', '1d':'1y', '1wk':'5y', '1mo':'10y' };

const CONSEILS = {
  ACHAT:    ["La tendance est ton amie. Achète dans le sens du marché.", "Signal d'achat confirmé. Pose ton stop-loss et laisse le trade travailler.", "Le marché monte. Entre avec discipline et respecte ton plan."],
  VENTE:    ["La tendance est baissière. Vends dans le sens du courant.", "Signal de vente confirmé. Définis ton risque avant tout.", "Le marché baisse. Suis la tendance, c'est ta meilleure alliée."],
  ATTENDRE: ["Pas de signal clair. Le trader gagnant sait aussi NE PAS trader.", "Patience. Attendre un bon setup vaut mieux que trader n'importe comment.", "Le marché n'est pas clair. Préserve ton capital."],
};

// ══════════════════════════════════════════════════════════════
// STATE
// ══════════════════════════════════════════════════════════════
let state = { tf:'1d', scanTf:'1d', riskPct:10 };

function setTF(btn, tf) {
  state.tf = tf;
  document.querySelectorAll('#tab-analyser .btn-tf').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function setScanTF(btn, tf) {
  state.scanTf = tf;
  document.querySelectorAll('#tab-scanner .btn-tf').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function setRisk(btn, r) {
  state.riskPct = r;
  document.querySelectorAll('.btn-risk').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function switchTab(name) {
  document.querySelectorAll('.t-nav-btn').forEach((b,i) => b.classList.toggle('active', ['analyser','scanner'][i]===name));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}

// ══════════════════════════════════════════════════════════════
// FETCH DONNÉES
// ══════════════════════════════════════════════════════════════
async function fetchCandles(symbol, interval, range) {
  const url = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}&includePrePost=false`;
  const proxies = [
    `https://corsproxy.io/?url=${encodeURIComponent(url)}`,
    `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  ];
  let lastErr = null;
  for (const proxy of proxies) {
    try {
      const res = await fetch(proxy, { signal: AbortSignal.timeout(12000) });
      if (!res.ok) { lastErr = `HTTP ${res.status}`; continue; }
      const json = await res.json();
      const result = json?.chart?.result?.[0];
      if (!result?.timestamp) { lastErr = 'Pas de données'; continue; }
      const ts = result.timestamp, q = result.indicators.quote[0];
      const candles = [];
      for (let i = 0; i < ts.length; i++) {
        if (q.close[i]!=null&&q.open[i]!=null&&q.high[i]!=null&&q.low[i]!=null)
          candles.push({ t:ts[i]*1000, o:q.open[i], h:q.high[i], l:q.low[i], c:q.close[i] });
      }
      if (candles.length < 50) { lastErr = `Seulement ${candles.length} bougies`; continue; }
      return candles;
    } catch(e) { lastErr = e.message; }
  }
  throw new Error(lastErr || 'Échec de la requête');
}

// ══════════════════════════════════════════════════════════════
// INDICATEURS TECHNIQUES
// ══════════════════════════════════════════════════════════════
function sma(arr, n) {
  const r = new Array(arr.length).fill(null);
  for (let i=n-1;i<arr.length;i++) { let s=0; for(let j=0;j<n;j++) s+=arr[i-j]; r[i]=s/n; }
  return r;
}
function ema(arr, n) {
  const k=2/(n+1), r=new Array(arr.length).fill(null);
  let s=0; for(let i=0;i<n;i++) s+=arr[i]; r[n-1]=s/n;
  for(let i=n;i<arr.length;i++) r[i]=arr[i]*k+r[i-1]*(1-k);
  return r;
}
function calcRSI(closes, n=14) {
  const r=new Array(closes.length).fill(null);
  if(closes.length<n+1) return r;
  let aG=0,aL=0;
  for(let i=1;i<=n;i++){const d=closes[i]-closes[i-1];if(d>0)aG+=d;else aL-=d;}
  aG/=n;aL/=n;
  r[n]=aL===0?100:100-100/(1+aG/aL);
  for(let i=n+1;i<closes.length;i++){
    const d=closes[i]-closes[i-1];
    aG=(aG*(n-1)+Math.max(0,d))/n;aL=(aL*(n-1)+Math.max(0,-d))/n;
    r[i]=aL===0?100:100-100/(1+aG/aL);
  }
  return r;
}
function calcMACD(closes,fast=12,slow=26,sig=9){
  const eF=ema(closes,fast),eS=ema(closes,slow);
  const ml=closes.map((_,i)=>eF[i]!=null&&eS[i]!=null?eF[i]-eS[i]:null);
  const sl=new Array(closes.length).fill(null);
  const fi=ml.findIndex(v=>v!=null);
  if(fi>=0&&fi+sig<closes.length){
    let s=0;for(let i=fi;i<fi+sig;i++)s+=ml[i];sl[fi+sig-1]=s/sig;
    const k=2/(sig+1);for(let i=fi+sig;i<closes.length;i++)sl[i]=ml[i]*k+sl[i-1]*(1-k);
  }
  const hist=closes.map((_,i)=>ml[i]!=null&&sl[i]!=null?ml[i]-sl[i]:null);
  return{ml,sl,hist};
}
function calcATR(highs,lows,closes,n=14){
  const r=new Array(closes.length).fill(null),tr=new Array(closes.length).fill(null);
  for(let i=1;i<closes.length;i++)
    tr[i]=Math.max(highs[i]-lows[i],Math.abs(highs[i]-closes[i-1]),Math.abs(lows[i]-closes[i-1]));
  let s=0;for(let i=1;i<=n;i++)s+=tr[i];r[n]=s/n;
  for(let i=n+1;i<closes.length;i++)r[i]=(r[i-1]*(n-1)+tr[i])/n;
  return r;
}

// ══════════════════════════════════════════════════════════════
// CERVEAU DU TRADER
// ══════════════════════════════════════════════════════════════
function traderBrain(symbol, candles, capital, riskPct) {
  const info = PAIR_INFO[symbol]||{pipMult:10000,pipVal:8.5,dec:5};
  const closes=candles.map(c=>c.c),highs=candles.map(c=>c.h),lows=candles.map(c=>c.l);
  const n=closes.length;
  const ma20a=sma(closes,20),ma50a=sma(closes,50),ma200a=sma(closes,200);
  const rsiA=calcRSI(closes,14);
  const{ml:macdL,sl:macdS,hist:macdH}=calcMACD(closes);
  const atrA=calcATR(highs,lows,closes,14);
  const price=closes[n-1],ma20=ma20a[n-1],ma50=ma50a[n-1],ma200=ma200a[n-1];
  const rsiV=rsiA[n-1],macdV=macdL[n-1],macdSV=macdS[n-1],macdHV=macdH[n-1],atrV=atrA[n-1];
  if(!ma200||!rsiV||!macdV||!atrV)
    return{signal:'ATTENDRE',score:0,reasons:['Données insuffisantes (200 bougies min.)'],warnings:[],price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt:null};
  const ma20slice=ma20a.slice(Math.max(0,n-5)).filter(v=>v!=null);
  const slopeMa20=ma20slice.length>=2?(ma20slice[ma20slice.length-1]-ma20slice[0])/ma20slice[0]*100:0;
  let direction;
  if(ma20>ma50&&slopeMa20>0)direction='HAUSSE';
  else if(ma20<ma50&&slopeMa20<0)direction='BAISSE';
  else direction='NEUTRE';
  let score=0;const reasons=[],warnings=[];
  if(direction==='HAUSSE'){
    score+=25;reasons.push('Tendance haussière confirmée (MA20 > MA50)');
    if(ma50<ma200)warnings.push('MA50 sous MA200 — tendance de fond baissière');
    else{score+=15;reasons.push('Tendance long terme haussière (MA50 > MA200)');}
    if(slopeMa20>0.05){score+=10;reasons.push('Pente MA20 positive — accélération haussière');}
  }else if(direction==='BAISSE'){
    score+=25;reasons.push('Tendance baissière confirmée (MA20 < MA50)');
    if(ma50>ma200)warnings.push('MA50 au-dessus MA200 — tendance de fond haussière');
    else{score+=15;reasons.push('Tendance long terme baissière (MA50 < MA200)');}
    if(slopeMa20<-0.05){score+=10;reasons.push('Pente MA20 négative — accélération baissière');}
  }else{warnings.push('Tendance neutre/indécise — pas de direction claire');}
  if(direction==='HAUSSE'){
    if(rsiV>=45&&rsiV<=60){score+=20;reasons.push(`RSI favorable achat (${rsiV.toFixed(1)})`);}
    else if(rsiV<=30){score+=15;reasons.push(`RSI en survente (${rsiV.toFixed(1)}) — rebond possible`);}
    else if(rsiV>=70){score-=10;warnings.push(`RSI en surachat (${rsiV.toFixed(1)}) — risque de correction`);}
  }else if(direction==='BAISSE'){
    if(rsiV>=40&&rsiV<=55){score+=20;reasons.push(`RSI favorable vente (${rsiV.toFixed(1)})`);}
    else if(rsiV>=70){score+=15;reasons.push(`RSI en surachat (${rsiV.toFixed(1)}) — baisse possible`);}
    else if(rsiV<=30){score-=10;warnings.push(`RSI en survente (${rsiV.toFixed(1)}) — risque de rebond`);}
  }
  const macdBull=macdV>macdSV&&macdHV>0,macdBear=macdV<macdSV&&macdHV<0;
  if(direction==='HAUSSE'&&macdBull){score+=20;reasons.push('MACD haussier — momentum confirmé');}
  else if(direction==='BAISSE'&&macdBear){score+=20;reasons.push('MACD baissier — momentum confirmé');}
  else warnings.push('MACD non aligné avec la tendance');
  if(direction==='HAUSSE'&&price>ma50){score+=10;reasons.push('Prix au-dessus MA50 — zone haussière');}
  else if(direction==='BAISSE'&&price<ma50){score+=10;reasons.push('Prix sous MA50 — zone baissière');}
  score=Math.max(0,Math.min(100,score));
  let signal;
  if(score>=60&&direction==='HAUSSE')signal='ACHAT';
  else if(score>=60&&direction==='BAISSE')signal='VENTE';
  else{signal='ATTENDRE';reasons.push(`Score insuffisant (${score}/100)`);}
  let riskMgmt=null;
  if(signal!=='ATTENDRE'){
    const slDist=atrV*1.5,tp1Dist=atrV*2.5,tp2Dist=atrV*4.0;
    const sl=signal==='ACHAT'?price-slDist:price+slDist;
    const tp1=signal==='ACHAT'?price+tp1Dist:price-tp1Dist;
    const tp2=signal==='ACHAT'?price+tp2Dist:price-tp2Dist;
    const slPips=Math.abs(price-sl)*info.pipMult;
    const tp1Pips=Math.abs(price-tp1)*info.pipMult;
    const tp2Pips=Math.abs(price-tp2)*info.pipMult;
    const rr=tp1Pips/slPips;
    if(rr<2.0){warnings.push(`Ratio R/R insuffisant (1:${rr.toFixed(1)}) — minimum 1:2`);signal='ATTENDRE';}
    else{
      const riskEur=capital*riskPct/100;
      const lots=Math.floor((riskEur/(slPips*info.pipVal))*100)/100;
      const realRisk=slPips*info.pipVal*lots;
      riskMgmt={
        entry:price.toFixed(info.dec),sl:sl.toFixed(info.dec),
        tp1:tp1.toFixed(info.dec),tp2:tp2.toFixed(info.dec),
        slPips:slPips.toFixed(1),tp1Pips:tp1Pips.toFixed(1),tp2Pips:tp2Pips.toFixed(1),
        lots:lots.toFixed(2),rr:rr.toFixed(2),
        riskEur:realRisk.toFixed(2),
        profit1:(tp1Pips*info.pipVal*lots).toFixed(2),
        profit2:(tp2Pips*info.pipVal*lots).toFixed(2),
      };
    }
  }
  const conseil=CONSEILS[signal][Math.floor(Math.random()*3)];
  return{signal,score,direction,slopeMa20,price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt,reasons,warnings,conseil};
}

// ══════════════════════════════════════════════════════════════
// RENDER RESULT — TERMINAL STYLE
// ══════════════════════════════════════════════════════════════
function renderResult(res, symbol) {
  const info  = PAIR_INFO[symbol]||{name:symbol,dec:5};
  const d     = info.dec;
  const sigCls = res.signal==='ACHAT'?'buy':res.signal==='VENTE'?'sell':'wait';
  const sigLbl = res.signal==='ACHAT'?'▲ ACHAT':res.signal==='VENTE'?'▼ VENTE':'◆ ATTENDRE';
  const barColor = res.score>=70?'#00ff94':res.score>=50?'#ffad00':'#ff2d55';
  const forceLabel = res.score>=80?'FORT':res.score>=60?'MOYEN':'FAIBLE';
  const dirArrow = res.direction==='HAUSSE'?'▲':res.direction==='BAISSE'?'▼':'—';
  const dirCls   = res.direction==='HAUSSE'?'v-green':res.direction==='BAISSE'?'v-red':'v-amber';
  const macdSig  = res.macdV>res.macdSV&&res.macdHV>0?'HAUSSIER':res.macdV<res.macdSV&&res.macdHV<0?'BAISSIER':'NEUTRE';
  const macdCls  = macdSig==='HAUSSIER'?'v-green':macdSig==='BAISSIER'?'v-red':'v-amber';
  const rsiCls   = res.rsiV>=70?'v-red':res.rsiV<=30?'v-green':'v-cyan';

  let html = `<div class="t-out">`;

  // ── Signal header ──
  html += `
  <div class="sig-header">
    <div class="sig-meta">${info.name} · ${state.tf.toUpperCase()} · ${new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</div>
    <div class="sig-main">
      <div class="sig-val ${sigCls}">${sigLbl}</div>
      <div class="sig-score-block">
        <div class="sig-score-num">CONFIANCE ${res.score}/100</div>
        <div class="sig-bar-bg">
          <div class="sig-bar-fg" style="width:${res.score}%;background:${barColor}"></div>
        </div>
        <div class="sig-force">FORCE: ${forceLabel}</div>
      </div>
    </div>
  </div>`;

  // ── Data grid ──
  html += `
  <div class="t-grid">
    <div class="t-cell">
      <div class="t-cell-label">Prix actuel</div>
      <div class="t-cell-val v-cyan">${res.price?.toFixed(d)}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">Tendance</div>
      <div class="t-cell-val ${dirCls}">${dirArrow} ${res.direction}</div>
      <div class="t-cell-sub">Pente MA20 : ${res.slopeMa20?.toFixed(3)}%</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">MA20</div>
      <div class="t-cell-val">${res.ma20?.toFixed(d)}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">MA50</div>
      <div class="t-cell-val">${res.ma50?.toFixed(d)}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">RSI (14)</div>
      <div class="t-cell-val ${rsiCls}">${res.rsiV?.toFixed(1)}</div>
      <div class="t-cell-sub">${res.rsiV>=70?'SURACHAT':res.rsiV<=30?'SURVENTE':'Neutre'}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">MACD</div>
      <div class="t-cell-val ${macdCls}">${macdSig}</div>
      <div class="t-cell-sub">Hist: ${res.macdHV?.toFixed(5)}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">MA200</div>
      <div class="t-cell-val">${res.ma200?.toFixed(d)}</div>
    </div>
    <div class="t-cell">
      <div class="t-cell-label">ATR (vol.)</div>
      <div class="t-cell-val">${res.atrV?.toFixed(d)}</div>
    </div>
  </div>`;

  // ── Plan de trade ──
  if (res.riskMgmt) {
    const rm = res.riskMgmt;
    const rrN = parseFloat(rm.rr);
    const rrCls = rrN>=2?'good':rrN>=1.5?'ok':'bad';
    html += `
  <div class="t-plan">
    <div class="t-plan-lot">
      <div class="t-plan-lot-num">${rm.lots}</div>
      <div class="t-plan-lot-info">
        <div class="t-plan-lot-label">LOTS RECOMMANDÉS</div>
        <div class="t-plan-lot-label">Risque : ${rm.riskEur} EUR</div>
        <div class="t-plan-rr ${rrCls}">R/R 1:${rm.rr}</div>
      </div>
    </div>
    <div class="t-level">
      <span class="t-level-tag">ENTRÉE</span>
      <span class="t-level-price v-cyan">${rm.entry}</span>
      <span class="t-level-pips">—</span>
    </div>
    <div class="t-level">
      <span class="t-level-tag v-red">STOP LOSS</span>
      <span class="t-level-price v-red">${rm.sl}</span>
      <span class="t-level-pips v-dim">${rm.slPips} pips</span>
    </div>
    <div class="t-level">
      <span class="t-level-tag v-green">TP 1</span>
      <span class="t-level-price v-green">${rm.tp1}</span>
      <span class="t-level-pips v-green">+${rm.profit1} € &nbsp;${rm.tp1Pips}p</span>
    </div>
    <div class="t-level">
      <span class="t-level-tag v-green">TP 2</span>
      <span class="t-level-price v-green">${rm.tp2}</span>
      <span class="t-level-pips v-green">+${rm.profit2} € &nbsp;${rm.tp2Pips}p</span>
    </div>
  </div>`;
  }

  // ── Raisons ──
  if (res.reasons?.length) {
    html += `<div class="t-log"><div class="t-log-title">Raisons du signal</div>`;
    res.reasons.forEach(r => { html += `<div class="t-log-item ok">${r}</div>`; });
    html += `</div>`;
  }

  // ── Avertissements ──
  if (res.warnings?.length) {
    html += `<div class="t-log"><div class="t-log-title" style="color:var(--amber)">Avertissements</div>`;
    res.warnings.forEach(w => { html += `<div class="t-log-item warn">${w}</div>`; });
    html += `</div>`;
  }

  // ── Conseil ──
  if (res.conseil) {
    html += `
  <div class="t-advice">
    <div class="t-advice-tag">// Trader Pro</div>
    <div class="t-advice-text">${res.conseil}</div>
  </div>`;
  }

  html += `</div>`;
  return html;
}

// ══════════════════════════════════════════════════════════════
// RUN ANALYSIS
// ══════════════════════════════════════════════════════════════
async function runAnalysis() {
  const symbol  = document.getElementById('pairSelect').value;
  const capital = parseFloat(document.getElementById('capitalInput').value)||1000;
  const btn = document.getElementById('btnAnalyse');
  const out = document.getElementById('analysisResult');

  btn.disabled = true;
  out.innerHTML = `
    <div class="t-loading">
      <div class="t-loading-line"><div class="t-spinner"></div>&nbsp;Connexion au marché…</div>
    </div>`;

  try {
    const range   = RANGE_MAP[state.tf]||'1y';
    const candles = await fetchCandles(symbol, state.tf, range);
    out.querySelector('.t-loading').innerHTML = `<div class="t-loading-line"><div class="t-spinner"></div>&nbsp;Calcul des indicateurs…</div>`;
    const result  = traderBrain(symbol, candles, capital, state.riskPct);
    out.innerHTML = renderResult(result, symbol);
  } catch(e) {
    out.innerHTML = `<div class="t-error">ERR // ${e.message}<br>Vérifier la connexion et réessayer.</div>`;
  } finally {
    btn.disabled = false;
  }
}

// ══════════════════════════════════════════════════════════════
// RUN SCAN
// ══════════════════════════════════════════════════════════════
async function runScan() {
  const btn = document.getElementById('btnScan');
  const out = document.getElementById('scanResult');
  const capital = 1000;

  btn.disabled = true;
  const total = FOREX_SCAN_PAIRS.length;

  out.innerHTML = `
    <div class="scan-progress">
      <div class="scan-prog-label" id="pgLabel">Initialisation…</div>
      <div class="scan-prog-bar-bg"><div class="scan-prog-bar-fill" id="pgBar" style="width:0%"></div></div>
    </div>`;

  const results = [];
  for (let i = 0; i < FOREX_SCAN_PAIRS.length; i++) {
    const sym = FOREX_SCAN_PAIRS[i];
    const pct = Math.round((i+1)/total*100);
    document.getElementById('pgLabel').textContent = `${i+1}/${total} — ${PAIR_INFO[sym]?.name||sym}`;
    document.getElementById('pgBar').style.width = pct+'%';
    try {
      const range   = RANGE_MAP[state.scanTf]||'1y';
      const candles = await fetchCandles(sym, state.scanTf, range);
      const res     = traderBrain(sym, candles, capital, 2);
      results.push({ sym, res });
    } catch(e) { results.push({ sym, res:null, err:e.message }); }
    if (i < FOREX_SCAN_PAIRS.length-1) await delay(600);
  }

  results.sort((a,b)=>{
    const ord={ACHAT:0,VENTE:1,ATTENDRE:2};
    const sa=a.res?.signal||'ATTENDRE', sb=b.res?.signal||'ATTENDRE';
    if(ord[sa]!==ord[sb]) return ord[sa]-ord[sb];
    return (b.res?.score||0)-(a.res?.score||0);
  });

  const nb_a = results.filter(r=>r.res?.signal==='ACHAT').length;
  const nb_v = results.filter(r=>r.res?.signal==='VENTE').length;
  const nb_w = results.filter(r=>r.res?.signal==='ATTENDRE'||!r.res).length;

  let html = `
  <div class="scan-summary">
    <div class="scan-sum-cell">
      <div class="scan-sum-num v-green">${nb_a}</div>
      <div class="scan-sum-label">Achat</div>
    </div>
    <div class="scan-sum-cell">
      <div class="scan-sum-num v-red">${nb_v}</div>
      <div class="scan-sum-label">Vente</div>
    </div>
    <div class="scan-sum-cell">
      <div class="scan-sum-num v-amber">${nb_w}</div>
      <div class="scan-sum-label">Attendre</div>
    </div>
  </div>
  <div class="scan-table-wrap">
  <table>
    <thead><tr><th>Paire</th><th>Signal</th><th>Score</th><th>Dir.</th><th>RSI</th></tr></thead>
    <tbody>`;

  results.forEach(({sym,res,err})=>{
    const info=PAIR_INFO[sym]||{name:sym};
    if(!res){
      html+=`<tr class="r-wait"><td>${info.name}</td><td colspan="4" style="color:var(--dim);font-size:.65rem">${err||'ERR'}</td></tr>`;
      return;
    }
    const sigStr = res.signal==='ACHAT'?`<span style="color:#00ff94;font-weight:600">▲ ACHAT</span>`:res.signal==='VENTE'?`<span style="color:#ff2d55;font-weight:600">▼ VENTE</span>`:`<span style="color:#ffad00">◆</span>`;
    const dirStr = res.direction==='HAUSSE'?`<span style="color:#00ff94">▲</span>`:res.direction==='BAISSE'?`<span style="color:#ff2d55">▼</span>`:`<span style="color:#ffad00">—</span>`;
    const sc     = res.score>=70?'#00ff94':res.score>=50?'#ffad00':'#ff2d55';
    const rowCls = res.signal==='ACHAT'?'r-buy':res.signal==='VENTE'?'r-sell':'r-wait';
    html+=`<tr class="${rowCls}"><td style="font-weight:600">${info.name}</td><td>${sigStr}</td><td style="color:${sc};font-weight:700">${res.score}</td><td>${dirStr}</td><td>${res.rsiV?.toFixed(1)??'—'}</td></tr>`;
  });

  html += `</tbody></table></div>`;
  out.innerHTML = html;
  btn.disabled = false;
}

function delay(ms) { return new Promise(r=>setTimeout(r,ms)); }
</script>
</body>
</html>
