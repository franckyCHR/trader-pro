<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trader Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Archivo+Narrow:wght@400;500;600;700&family=JetBrains+Mono:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
/* ─── RESET ─────────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:14px;-webkit-font-smoothing:antialiased}

/* ─── TOKENS ─────────────────────────────────────────── */
:root{
  --bg:    #080808;
  --s1:    #101010;
  --s2:    #181818;
  --b1:    #202020;
  --b2:    #2e2e2e;
  --b3:    #3c3c3c;
  --dim:   #505050;
  --mid:   #787878;
  --body:  #b4b4b4;
  --main:  #e8e8e8;
  --white: #ffffff;
  --buy:   #00c896;
  --sell:  #ff4d6a;
  --wait:  #606060;
  --sans:  'Archivo Narrow', sans-serif;
  --mono:  'JetBrains Mono', monospace;
  --hdr:   48px;
}

/* ─── BASE ───────────────────────────────────────────── */
body{font-family:var(--sans);background:var(--bg);color:var(--body);min-height:100vh}
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--b2)}

/* ─── HEADER ─────────────────────────────────────────── */
.hdr{
  height:var(--hdr);background:var(--s1);border-bottom:1px solid var(--b1);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;position:sticky;top:0;z-index:100;
}
.logo{font-family:var(--mono);font-size:.9rem;font-weight:600;letter-spacing:.12em;color:var(--white)}
.logo span{color:var(--mid);font-weight:300}
.nav{display:flex;gap:2px}
.nav-btn{
  font-family:var(--sans);font-size:.72rem;font-weight:600;letter-spacing:.06em;
  text-transform:uppercase;color:var(--dim);background:none;border:none;
  padding:6px 11px;cursor:pointer;transition:color .15s;border-bottom:2px solid transparent;
}
.nav-btn.active{color:var(--white);border-bottom-color:var(--white)}
.nav-btn:hover:not(.active){color:var(--body)}

/* ─── LAYOUT ─────────────────────────────────────────── */
.shell{display:grid;grid-template-columns:1fr;min-height:calc(100vh - var(--hdr))}
@media(min-width:768px){.shell{grid-template-columns:280px 1fr}}
@media(min-width:1024px){.shell{grid-template-columns:300px 1fr}}

/* ─── SIDEBAR ─────────────────────────────────────────── */
.sidebar{border-right:1px solid var(--b1);padding:20px;display:flex;flex-direction:column;gap:0}
@media(min-width:768px){
  .sidebar{position:sticky;top:var(--hdr);height:calc(100vh - var(--hdr));overflow-y:auto}
}

/* ─── MAIN ─────────────────────────────────────────────── */
.main{padding:20px;min-height:calc(100vh - var(--hdr))}
@media(min-width:768px){.main{padding:24px 28px}}

/* ─── TAB PAGES ──────────────────────────────────────── */
.tab-content{display:none}
.tab-content.active{display:block}

/* ─── SECTION LABEL ──────────────────────────────────── */
.sec-label{
  font-family:var(--mono);font-size:.6rem;font-weight:500;letter-spacing:.14em;
  text-transform:uppercase;color:var(--dim);padding:16px 0 8px;
  border-bottom:1px solid var(--b1);margin-bottom:12px;
}
.sec-label:first-child{padding-top:0}

/* ─── FIELD ──────────────────────────────────────────── */
.field{margin-bottom:14px}
.field-label{
  font-size:.68rem;font-weight:600;letter-spacing:.08em;text-transform:uppercase;
  color:var(--dim);margin-bottom:5px;
}

/* ─── SELECT / INPUT ─────────────────────────────────── */
.ctrl-select,.ctrl-input{
  width:100%;background:var(--s2);border:1px solid var(--b1);color:var(--main);
  font-family:var(--sans);font-size:.9rem;font-weight:500;padding:8px 10px;
  outline:none;transition:border-color .15s;-moz-appearance:textfield;border-radius:2px;
}
.ctrl-select::-webkit-outer-spin-button,.ctrl-select::-webkit-inner-spin-button{-webkit-appearance:none}
.ctrl-input::-webkit-outer-spin-button,.ctrl-input::-webkit-inner-spin-button{-webkit-appearance:none}
.ctrl-select:focus,.ctrl-input:focus{border-color:var(--b3)}
.ctrl-select{
  cursor:pointer;appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6' fill='%23505050'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  background-color:var(--s2);padding-right:30px;
}
.ctrl-select option{background:var(--s1);color:var(--main)}
.ctrl-select optgroup{color:var(--dim);font-size:.8rem}

/* ─── BUTTON GROUPS ──────────────────────────────────── */
.btn-row{display:flex;flex-wrap:wrap;gap:4px}
.btn-chip{
  font-family:var(--mono);font-size:.68rem;font-weight:500;letter-spacing:.04em;
  background:var(--s2);border:1px solid var(--b1);color:var(--dim);
  padding:5px 9px;cursor:pointer;transition:all .12s;border-radius:2px;
}
.btn-chip.active{background:var(--b2);border-color:var(--b3);color:var(--white)}
.btn-chip:hover:not(.active){border-color:var(--b2);color:var(--body)}

/* ─── ACTION BUTTON ──────────────────────────────────── */
.btn-action{
  width:100%;padding:11px;background:var(--white);border:none;color:var(--bg);
  font-family:var(--sans);font-size:.85rem;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;cursor:pointer;transition:background .15s,opacity .15s;
  border-radius:2px;margin-top:20px;
}
.btn-action:hover{background:var(--main)}
.btn-action:disabled{opacity:.35;cursor:not-allowed}

/* ─── LOADING ─────────────────────────────────────────── */
.loading{padding:32px 0;display:flex;flex-direction:column;gap:10px;color:var(--mid);font-family:var(--mono);font-size:.72rem}
.loading-row{display:flex;align-items:center;gap:8px}
.sp{width:12px;height:12px;border:1px solid var(--b2);border-top-color:var(--mid);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}

/* ─── EMPTY STATE ─────────────────────────────────────── */
.empty{padding:48px 0;text-align:center;color:var(--dim);font-size:.8rem;line-height:1.8}
.empty-icon{font-size:1.6rem;margin-bottom:8px;display:block;opacity:.3}

/* ─── SIGNAL BLOCK ───────────────────────────────────── */
.sig-block{padding-bottom:16px;margin-bottom:16px;border-bottom:1px solid var(--b1)}
.sig-pair{font-family:var(--mono);font-size:.62rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-bottom:8px}
.sig-main-row{display:flex;align-items:flex-end;gap:20px;flex-wrap:wrap;margin-bottom:10px}
.sig-val{font-family:var(--mono);font-size:2.2rem;font-weight:600;line-height:1;letter-spacing:-.02em}
.sig-val.buy{color:var(--buy)}
.sig-val.sell{color:var(--sell)}
.sig-val.wait{color:var(--wait)}
.sig-score-wrap{display:flex;flex-direction:column;gap:4px;padding-bottom:4px}
.sig-score-txt{font-family:var(--mono);font-size:.62rem;color:var(--dim);letter-spacing:.06em}
.sig-bar{height:3px;background:var(--b1);width:160px;border-radius:1px;overflow:hidden}
.sig-bar-fill{height:100%;background:var(--mid);transition:width .6s ease;border-radius:1px}
.sig-bar-fill.fill-buy{background:var(--buy)}
.sig-bar-fill.fill-sell{background:var(--sell)}
.sig-bar-fill.fill-wait{background:var(--dim)}
.sig-force{font-family:var(--mono);font-size:.58rem;color:var(--dim);letter-spacing:.1em;text-transform:uppercase}

/* ─── DATA TABLE ─────────────────────────────────────── */
.data-table{width:100%;border-collapse:collapse;margin-bottom:16px}
.data-table td{padding:7px 0;border-bottom:1px solid var(--b1);font-size:.82rem}
.data-table td:first-child{font-family:var(--mono);font-size:.6rem;letter-spacing:.08em;text-transform:uppercase;color:var(--dim);width:100px}
.data-table td:last-child{font-family:var(--mono);font-weight:500;color:var(--main);text-align:right}
.data-table tr:last-child td{border-bottom:none}
.v-w{color:var(--white)!important}
.v-g{color:#a0a0a0!important}
.v-d{color:var(--dim)!important}

/* ─── PLAN BLOCK ─────────────────────────────────────── */
.plan-block{border:1px solid var(--b1);padding:14px;margin-bottom:16px;border-radius:2px}
.plan-hdr{display:flex;align-items:baseline;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--b1);flex-wrap:wrap;gap:8px}
.plan-lot-num{font-family:var(--mono);font-size:2.8rem;font-weight:600;color:var(--white);line-height:1;letter-spacing:-.04em;animation:pop .35s ease}
@keyframes pop{0%{transform:scale(.92);opacity:0}100%{transform:scale(1);opacity:1}}
.plan-lot-label{font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-top:3px}
.plan-rr{font-family:var(--mono);font-size:.75rem;font-weight:600;padding:4px 10px;border:1px solid var(--b2);color:var(--main);border-radius:2px;align-self:flex-end}
.level-row{display:grid;grid-template-columns:70px 1fr 1fr;gap:8px;align-items:center;padding:5px 0;border-bottom:1px solid var(--b1);font-size:.8rem}
.level-row:last-child{border-bottom:none}
.level-tag{font-family:var(--mono);font-size:.58rem;letter-spacing:.08em;color:var(--dim);text-transform:uppercase}
.level-price{font-family:var(--mono);font-weight:500;color:var(--main);text-align:center}
.level-info{font-family:var(--mono);font-size:.68rem;color:var(--mid);text-align:right}

/* ─── LOG ITEMS ──────────────────────────────────────── */
.log-block{margin-bottom:14px}
.log-title{font-family:var(--mono);font-size:.58rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--b1)}
.log-item{font-size:.78rem;color:var(--body);padding:4px 0 4px 12px;position:relative;line-height:1.5;border-bottom:1px solid var(--b1)}
.log-item:last-child{border-bottom:none}
.log-item::before{position:absolute;left:0;color:var(--dim)}
.log-item.ok::before{content:'+';color:var(--mid)}
.log-item.warn::before{content:'!';color:var(--mid)}
.log-item.warn{color:var(--mid)}

/* ─── ADVICE ─────────────────────────────────────────── */
.advice{padding:12px;background:var(--s1);border-left:2px solid var(--b3);margin-bottom:14px}
.advice-tag{font-family:var(--mono);font-size:.56rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:5px}
.advice-txt{font-size:.8rem;color:var(--body);line-height:1.6;font-style:italic}

/* ─── ERROR ──────────────────────────────────────────── */
.err{padding:12px;background:var(--s2);border-left:2px solid var(--b3);font-family:var(--mono);font-size:.72rem;color:var(--mid);line-height:1.7}
.err strong{color:var(--main);font-weight:600}

/* ─── SCANNER ─────────────────────────────────────────── */
.scan-prog{padding:32px 0;font-family:var(--mono);font-size:.7rem;color:var(--mid)}
.scan-prog-bar-bg{height:1px;background:var(--b1);margin:8px 0;position:relative;overflow:hidden}
.scan-prog-bar-fill{position:absolute;top:0;left:0;height:100%;background:var(--white);transition:width .3s}
.scan-prog-label{color:var(--dim);letter-spacing:.04em}
.scan-sum{display:grid;grid-template-columns:repeat(3,1fr);border:1px solid var(--b1);margin-bottom:20px;border-radius:2px}
.scan-sum-cell{padding:14px 10px;text-align:center;border-right:1px solid var(--b1)}
.scan-sum-cell:last-child{border-right:none}
.scan-sum-num{font-family:var(--mono);font-size:1.8rem;font-weight:600;color:var(--white);line-height:1}
.scan-sum-label{font-family:var(--mono);font-size:.56rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-top:4px}
.scan-tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse}
thead tr{border-bottom:1px solid var(--b2)}
th{font-family:var(--mono);font-size:.58rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding:6px 8px;text-align:left}
th:not(:first-child){text-align:right}
td{font-family:var(--mono);font-size:.78rem;padding:7px 8px;border-bottom:1px solid var(--b1);color:var(--body)}
td:not(:first-child){text-align:right}
tr.r-b td:first-child{border-left:2px solid var(--buy)}
tr.r-s td:first-child{border-left:2px solid var(--sell)}
tr.r-w td:first-child{border-left:2px solid var(--b1);padding-left:6px}

/* ─── CALCULATOR ─────────────────────────────────────── */
.calc-dir-row{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:0}
.calc-btn-dir{
  padding:9px;border:1px solid var(--b1);background:var(--s2);color:var(--dim);
  font-family:var(--mono);font-size:.75rem;font-weight:600;letter-spacing:.06em;
  cursor:pointer;transition:all .15s;border-radius:2px;
}
.calc-btn-dir.buy.active{border-color:var(--buy);color:var(--buy);background:rgba(0,200,150,.08)}
.calc-btn-dir.sell.active{border-color:var(--sell);color:var(--sell);background:rgba(255,77,106,.08)}
.calc-btn-dir:hover:not(.active){border-color:var(--b2);color:var(--body)}

.pip-hint{font-family:var(--mono);font-size:.6rem;color:var(--dim);margin-top:3px;min-height:14px}
.pip-hint.valid{color:var(--buy)}

.calc-result-lot{
  border:1px solid var(--b1);padding:16px;margin-bottom:12px;border-radius:2px;
  display:flex;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;gap:8px;
}
.calc-lot-big{font-family:var(--mono);font-size:3rem;font-weight:600;color:var(--white);line-height:1;letter-spacing:-.04em;animation:pop .35s ease}
.calc-lot-sub{font-family:var(--mono);font-size:.58rem;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;margin-top:4px}
.calc-result-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px}
.calc-box{border:1px solid var(--b1);padding:10px 12px;border-radius:2px}
.calc-box-label{font-family:var(--mono);font-size:.56rem;letter-spacing:.1em;color:var(--dim);text-transform:uppercase;margin-bottom:4px}
.calc-box-val{font-family:var(--mono);font-size:1rem;font-weight:600;color:var(--main)}
.calc-box-val.green{color:var(--buy)}
.calc-box-val.red{color:var(--sell)}
.calc-box-sub{font-family:var(--mono);font-size:.58rem;color:var(--dim);margin-top:2px}

.rr-badge{display:inline-flex;align-items:center;gap:5px;padding:4px 10px;font-family:var(--mono);font-size:.72rem;font-weight:600;border-radius:2px}
.rr-badge.good{border:1px solid var(--buy);color:var(--buy);background:rgba(0,200,150,.08)}
.rr-badge.ok{border:1px solid var(--mid);color:var(--mid);background:var(--s2)}
.rr-badge.bad{border:1px solid var(--sell);color:var(--sell);background:rgba(255,77,106,.08)}

.pair-meta-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:6px}
.pair-meta-tag{font-family:var(--mono);font-size:.56rem;padding:2px 6px;border:1px solid var(--b1);color:var(--dim);border-radius:2px}
.pair-meta-tag span{color:var(--body)}

.input-row-live{display:flex;gap:4px;align-items:stretch}
.input-row-live .ctrl-input{flex:1}
.btn-live{
  flex-shrink:0;background:var(--s2);border:1px solid var(--b1);color:var(--dim);
  font-family:var(--mono);font-size:.62rem;font-weight:500;padding:0 10px;
  cursor:pointer;transition:all .15s;border-radius:2px;display:flex;align-items:center;gap:4px;
  white-space:nowrap;
}
.btn-live:hover{border-color:var(--b2);color:var(--body)}

.calc-comp-table{width:100%;border-collapse:collapse}
.calc-comp-table th{font-family:var(--mono);font-size:.56rem;font-weight:500;letter-spacing:.1em;text-transform:uppercase;color:var(--dim);padding:6px 8px;text-align:right;border-bottom:1px solid var(--b2)}
.calc-comp-table th:first-child{text-align:left}
.calc-comp-table td{font-family:var(--mono);font-size:.76rem;padding:6px 8px;border-bottom:1px solid var(--b1);color:var(--body);text-align:right}
.calc-comp-table td:first-child{text-align:left}
.calc-comp-table tr:last-child td{border-bottom:none}
.calc-comp-table tr.active-row td{color:var(--buy);font-weight:700}
.calc-comp-table tr.active-row td:first-child{border-left:2px solid var(--buy);padding-left:6px}

.calc-rules{margin-top:8px;border-top:1px solid var(--b1);padding-top:10px}
.calc-rules-toggle{
  font-family:var(--mono);font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--dim);cursor:pointer;display:flex;align-items:center;justify-content:space-between;
  padding:4px 0;background:none;border:none;width:100%;
}
.calc-rules-body{padding:10px 0 0;display:flex;flex-direction:column;gap:7px}
.calc-rule{display:flex;gap:8px;align-items:flex-start}
.calc-rule-txt{font-size:.75rem;color:var(--dim);line-height:1.4}
.calc-rule-txt strong{color:var(--body)}
</style>
</head>
<body>

<!-- HEADER -->
<header class="hdr">
  <div class="logo">TRADER<span>/PRO</span></div>
  <nav class="nav">
    <button class="nav-btn active" onclick="switchTab('analyser')">Analyse</button>
    <button class="nav-btn" onclick="switchTab('scanner')">Scanner</button>
    <button class="nav-btn" onclick="switchTab('calculateur')">Calcul</button>
  </nav>
</header>

<!-- ════ TAB ANALYSER ════ -->
<div class="tab-content active" id="tab-analyser">
<div class="shell">
  <aside class="sidebar">
    <div class="sec-label">Instrument</div>
    <div class="field">
      <div class="field-label">Paire</div>
      <select id="pairSelect" class="ctrl-select">
        <optgroup label="Majeures">
          <option value="EURUSD=X">EUR/USD</option>
          <option value="GBPUSD=X" selected>GBP/USD</option>
          <option value="USDJPY=X">USD/JPY</option>
          <option value="USDCHF=X">USD/CHF</option>
          <option value="AUDUSD=X">AUD/USD</option>
          <option value="USDCAD=X">USD/CAD</option>
          <option value="NZDUSD=X">NZD/USD</option>
        </optgroup>
        <optgroup label="EUR Cross">
          <option value="EURGBP=X">EUR/GBP</option>
          <option value="EURJPY=X">EUR/JPY</option>
          <option value="EURAUD=X">EUR/AUD</option>
          <option value="EURCAD=X">EUR/CAD</option>
        </optgroup>
        <optgroup label="GBP Cross">
          <option value="GBPJPY=X">GBP/JPY</option>
          <option value="GBPAUD=X">GBP/AUD</option>
          <option value="GBPCAD=X">GBP/CAD</option>
        </optgroup>
        <optgroup label="Indices">
          <option value="^FCHI">CAC 40</option>
          <option value="^IXIC">NASDAQ</option>
          <option value="^GSPC">S&amp;P 500</option>
          <option value="^DJI">Dow Jones</option>
          <option value="^GDAXI">DAX</option>
        </optgroup>
        <optgroup label="Commodités">
          <option value="GC=F">Or / Gold</option>
          <option value="CL=F">Pétrole WTI</option>
        </optgroup>
      </select>
    </div>

    <div class="field">
      <div class="field-label">Timeframe</div>
      <div class="btn-row">
        <button class="btn-chip" data-tf="5m"  onclick="setTF(this,'5m')">5M</button>
        <button class="btn-chip" data-tf="15m" onclick="setTF(this,'15m')">15M</button>
        <button class="btn-chip" data-tf="30m" onclick="setTF(this,'30m')">30M</button>
        <button class="btn-chip" data-tf="60m" onclick="setTF(this,'60m')">1H</button>
        <button class="btn-chip" data-tf="4h"  onclick="setTF(this,'4h')">4H</button>
        <button class="btn-chip active" data-tf="1d" onclick="setTF(this,'1d')">1J</button>
        <button class="btn-chip" data-tf="1wk" onclick="setTF(this,'1wk')">1SEM</button>
        <button class="btn-chip" data-tf="1mo" onclick="setTF(this,'1mo')">1MOIS</button>
      </div>
    </div>

    <div class="sec-label">Money Management</div>
    <div class="field">
      <div class="field-label">Capital (€)</div>
      <input type="number" id="capitalInput" class="ctrl-input" value="1000" min="1" step="100">
    </div>
    <div class="field">
      <div class="field-label">Risque / trade</div>
      <div class="btn-row">
        <button class="btn-chip" data-r="1"  onclick="setRisk(this,1)">1%</button>
        <button class="btn-chip" data-r="2"  onclick="setRisk(this,2)">2%</button>
        <button class="btn-chip" data-r="3"  onclick="setRisk(this,3)">3%</button>
        <button class="btn-chip" data-r="5"  onclick="setRisk(this,5)">5%</button>
        <button class="btn-chip active" data-r="10" onclick="setRisk(this,10)">10%</button>
        <button class="btn-chip" data-r="15" onclick="setRisk(this,15)">15%</button>
        <button class="btn-chip" data-r="20" onclick="setRisk(this,20)">20%</button>
        <button class="btn-chip" data-r="30" onclick="setRisk(this,30)">30%</button>
      </div>
    </div>
    <button class="btn-action" id="btnAnalyse" onclick="runAnalysis()">Analyser</button>
  </aside>

  <main class="main">
    <div id="analysisResult">
      <div class="empty"><span class="empty-icon">◎</span>Sélectionne une paire et lance l'analyse</div>
    </div>
  </main>
</div>
</div>

<!-- ════ TAB SCANNER ════ -->
<div class="tab-content" id="tab-scanner">
<div class="shell">
  <aside class="sidebar">
    <div class="sec-label">Configuration</div>
    <div class="field">
      <div class="field-label">Timeframe</div>
      <div class="btn-row">
        <button class="btn-chip" data-stf="60m" onclick="setScanTF(this,'60m')">1H</button>
        <button class="btn-chip active" data-stf="1d" onclick="setScanTF(this,'1d')">1J</button>
        <button class="btn-chip" data-stf="1wk" onclick="setScanTF(this,'1wk')">1SEM</button>
        <button class="btn-chip" data-stf="1mo" onclick="setScanTF(this,'1mo')">1MOIS</button>
      </div>
    </div>
    <p style="font-size:.75rem;color:var(--dim);line-height:1.6;margin-bottom:16px">
      Analyse les 14 paires Forex majeures et affiche un classement par signal.
    </p>
    <button class="btn-action" id="btnScan" onclick="runScan()">Scanner</button>
  </aside>
  <main class="main">
    <div id="scanResult">
      <div class="empty"><span class="empty-icon">◎</span>Lance le scanner pour analyser toutes les paires</div>
    </div>
  </main>
</div>
</div>

<!-- ════ TAB CALCULATEUR ════ -->
<div class="tab-content" id="tab-calculateur">
<div class="shell">
  <aside class="sidebar">
    <div class="sec-label">Capital</div>
    <div class="field">
      <div class="field-label">Mon capital (€)</div>
      <input type="number" id="cc-capital" class="ctrl-input" value="1000" min="1" step="50">
    </div>

    <div class="sec-label">Paramètres du trade</div>
    <div class="field">
      <div class="field-label">Paire</div>
      <select id="cc-pair" class="ctrl-select">
        <optgroup label="Majeures">
          <option value="EURUSD">EUR/USD</option>
          <option value="GBPUSD" selected>GBP/USD</option>
          <option value="USDJPY">USD/JPY</option>
          <option value="USDCHF">USD/CHF</option>
          <option value="AUDUSD">AUD/USD</option>
          <option value="USDCAD">USD/CAD</option>
          <option value="NZDUSD">NZD/USD</option>
        </optgroup>
        <optgroup label="EUR Cross">
          <option value="EURGBP">EUR/GBP</option>
          <option value="EURJPY">EUR/JPY</option>
          <option value="EURCHF">EUR/CHF</option>
          <option value="EURAUD">EUR/AUD</option>
          <option value="EURCAD">EUR/CAD</option>
          <option value="EURNZD">EUR/NZD</option>
        </optgroup>
        <optgroup label="GBP Cross">
          <option value="GBPJPY">GBP/JPY</option>
          <option value="GBPCHF">GBP/CHF</option>
          <option value="GBPAUD">GBP/AUD</option>
          <option value="GBPCAD">GBP/CAD</option>
          <option value="GBPNZD">GBP/NZD</option>
        </optgroup>
        <optgroup label="AUD / NZD">
          <option value="AUDJPY">AUD/JPY</option>
          <option value="AUDCHF">AUD/CHF</option>
          <option value="AUDCAD">AUD/CAD</option>
          <option value="AUDNZD">AUD/NZD</option>
          <option value="NZDJPY">NZD/JPY</option>
          <option value="NZDCHF">NZD/CHF</option>
          <option value="NZDCAD">NZD/CAD</option>
        </optgroup>
        <optgroup label="CAD / CHF">
          <option value="CADJPY">CAD/JPY</option>
          <option value="CHFJPY">CHF/JPY</option>
          <option value="CADCHF">CAD/CHF</option>
        </optgroup>
        <optgroup label="Commodités &amp; Indices">
          <option value="XAUUSD">OR / Gold (XAU/USD)</option>
          <option value="DJ30">DJ30 / Dow Jones</option>
        </optgroup>
      </select>
      <div class="pair-meta-row" id="cc-pairMeta"></div>
    </div>

    <div class="field">
      <div class="field-label">Direction</div>
      <div class="calc-dir-row">
        <button class="calc-btn-dir buy active" id="cc-btnBuy" onclick="ccSetDir('BUY')">▲ BUY</button>
        <button class="calc-btn-dir sell" id="cc-btnSell" onclick="ccSetDir('SELL')">▼ SELL</button>
      </div>
    </div>

    <div class="field">
      <div class="field-label">Prix d'entrée</div>
      <div class="input-row-live">
        <input type="number" id="cc-entry" class="ctrl-input" step="0.00001" placeholder="ex: 1.35025">
        <button class="btn-live" id="cc-btnLive" onclick="ccFetchLive()">
          <span id="cc-liveIcon">⟳</span>&nbsp;Live
        </button>
      </div>
    </div>

    <div class="field">
      <div class="field-label">Stop Loss</div>
      <input type="number" id="cc-sl" class="ctrl-input" step="0.00001" placeholder="ex: 1.34250">
      <div class="pip-hint" id="cc-slHint">—</div>
    </div>

    <div class="field">
      <div class="field-label">Take Profit 1</div>
      <input type="number" id="cc-tp1" class="ctrl-input" step="0.00001" placeholder="ex: 1.36200">
      <div class="pip-hint" id="cc-tp1Hint">—</div>
    </div>

    <div class="field">
      <div class="field-label">Take Profit 2 <span style="color:var(--dim);font-weight:400">(optionnel)</span></div>
      <input type="number" id="cc-tp2" class="ctrl-input" step="0.00001" placeholder="ex: 1.37000">
      <div class="pip-hint" id="cc-tp2Hint">—</div>
    </div>

    <div class="sec-label">Risque / trade</div>
    <div class="field">
      <div class="btn-row" id="cc-riskGrid">
        <button class="btn-chip" data-cr="1"  onclick="ccSetRisk(1)">1%</button>
        <button class="btn-chip" data-cr="2"  onclick="ccSetRisk(2)">2%</button>
        <button class="btn-chip" data-cr="3"  onclick="ccSetRisk(3)">3%</button>
        <button class="btn-chip" data-cr="5"  onclick="ccSetRisk(5)">5%</button>
        <button class="btn-chip active" data-cr="10" onclick="ccSetRisk(10)">10%</button>
        <button class="btn-chip" data-cr="15" onclick="ccSetRisk(15)">15%</button>
        <button class="btn-chip" data-cr="20" onclick="ccSetRisk(20)">20%</button>
        <button class="btn-chip" data-cr="30" onclick="ccSetRisk(30)">30%</button>
      </div>
      <div style="font-family:var(--mono);font-size:.62rem;color:var(--dim);margin-top:6px" id="cc-riskHint">— €</div>
    </div>
  </aside>

  <main class="main">
    <div id="cc-result">
      <div class="empty"><span class="empty-icon">◈</span>Entrez les paramètres du trade</div>
    </div>
  </main>
</div>
</div>

<script>
// ═══════════════════════════════════════════════════════
// CONSTANTES — ANALYSER / SCANNER
// ═══════════════════════════════════════════════════════
const PAIR_INFO = {
  'EURUSD=X':{name:'EUR/USD',pipMult:10000,pipVal:8.50,dec:5},
  'GBPUSD=X':{name:'GBP/USD',pipMult:10000,pipVal:8.50,dec:5},
  'USDJPY=X':{name:'USD/JPY',pipMult:100,  pipVal:5.65,dec:3},
  'USDCHF=X':{name:'USD/CHF',pipMult:10000,pipVal:7.90,dec:5},
  'AUDUSD=X':{name:'AUD/USD',pipMult:10000,pipVal:8.50,dec:5},
  'USDCAD=X':{name:'USD/CAD',pipMult:10000,pipVal:6.10,dec:5},
  'NZDUSD=X':{name:'NZD/USD',pipMult:10000,pipVal:8.50,dec:5},
  'EURGBP=X':{name:'EUR/GBP',pipMult:10000,pipVal:11.05,dec:5},
  'EURJPY=X':{name:'EUR/JPY',pipMult:100,  pipVal:5.50,dec:3},
  'EURAUD=X':{name:'EUR/AUD',pipMult:10000,pipVal:6.00,dec:5},
  'EURCAD=X':{name:'EUR/CAD',pipMult:10000,pipVal:6.00,dec:5},
  'GBPJPY=X':{name:'GBP/JPY',pipMult:100,  pipVal:5.50,dec:3},
  'GBPAUD=X':{name:'GBP/AUD',pipMult:10000,pipVal:5.95,dec:5},
  'GBPCAD=X':{name:'GBP/CAD',pipMult:10000,pipVal:5.95,dec:5},
  '^FCHI'   :{name:'CAC 40', pipMult:1,    pipVal:0.93,dec:2},
  '^IXIC'   :{name:'NASDAQ', pipMult:1,    pipVal:0.93,dec:2},
  '^GSPC'   :{name:'S&P 500',pipMult:1,    pipVal:0.93,dec:2},
  '^DJI'    :{name:'Dow Jones',pipMult:1,  pipVal:0.93,dec:2},
  '^GDAXI'  :{name:'DAX',    pipMult:1,    pipVal:0.93,dec:2},
  'GC=F'    :{name:'Or/Gold',pipMult:100,  pipVal:0.93,dec:2},
  'CL=F'    :{name:'Pétrole',pipMult:100,  pipVal:0.93,dec:2},
};
const FOREX_SCAN_PAIRS = ['EURUSD=X','GBPUSD=X','USDJPY=X','USDCHF=X','AUDUSD=X','USDCAD=X','NZDUSD=X','EURGBP=X','EURJPY=X','EURAUD=X','EURCAD=X','GBPJPY=X','GBPAUD=X','GBPCAD=X'];
const RANGE_MAP = {
  '5m':'60d','15m':'60d','30m':'60d',
  '60m':'60d','4h':'60d',
  '1d':'1y','1wk':'5y','1mo':'10y'
};
const CONSEILS = {
  ACHAT:   ["La tendance est ton amie. Achète dans le sens du marché.","Signal d'achat confirmé. Pose ton stop-loss et laisse le trade travailler.","Le marché monte. Entre avec discipline et respecte ton plan."],
  VENTE:   ["La tendance est baissière. Vends dans le sens du courant.","Signal de vente confirmé. Définis ton risque avant tout.","Le marché baisse. Suis la tendance, c'est ta meilleure alliée."],
  ATTENDRE:["Pas de signal clair. Le trader gagnant sait aussi NE PAS trader.","Patience. Attendre un bon setup vaut mieux que trader n'importe comment.","Le marché n'est pas clair. Préserve ton capital."],
};

// ═══════════════════════════════════════════════════════
// STATE — ANALYSER / SCANNER
// ═══════════════════════════════════════════════════════
let state = {tf:'1d', scanTf:'1d', riskPct:10};

function setTF(btn,tf){
  state.tf=tf;
  document.querySelectorAll('#tab-analyser .btn-chip[data-tf]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function setScanTF(btn,tf){
  state.scanTf=tf;
  document.querySelectorAll('#tab-scanner .btn-chip[data-stf]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function setRisk(btn,r){
  state.riskPct=r;
  document.querySelectorAll('#tab-analyser .btn-chip[data-r]').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
function switchTab(name){
  document.querySelectorAll('.nav-btn').forEach((b,i)=>b.classList.toggle('active',['analyser','scanner','calculateur'][i]===name));
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
}

// ═══════════════════════════════════════════════════════
// FETCH — robuste avec timeout manuel
// ═══════════════════════════════════════════════════════
function fetchWithTimeout(url,ms=20000){
  const ctrl=new AbortController();
  const id=setTimeout(()=>ctrl.abort(),ms);
  return fetch(url,{signal:ctrl.signal}).finally(()=>clearTimeout(id));
}
async function fetchCandles(symbol,interval,range){
  const base =`https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}&includePrePost=false`;
  const base2=`https://query2.finance.yahoo.com/v8/finance/chart/${symbol}?interval=${interval}&range=${range}&includePrePost=false`;
  const attempts=[
    ()=>fetchWithTimeout(base,8000),
    ()=>fetchWithTimeout(base2,8000),
    ()=>fetchWithTimeout(`https://corsproxy.io/?url=${encodeURIComponent(base)}`,20000),
    ()=>fetchWithTimeout(`https://api.allorigins.win/raw?url=${encodeURIComponent(base)}`,20000),
    ()=>fetchWithTimeout(`https://thingproxy.freeboard.io/fetch/${base}`,20000),
  ];
  let lastErr='Toutes les tentatives ont échoué';
  for(const attempt of attempts){
    try{
      const res=await attempt();
      if(!res.ok){lastErr=`HTTP ${res.status}`;continue;}
      const json=await res.json();
      const result=json?.chart?.result?.[0];
      if(!result?.timestamp){lastErr='Format inattendu';continue;}
      const ts=result.timestamp,q=result.indicators.quote[0];
      const candles=[];
      for(let i=0;i<ts.length;i++){
        if(q.close[i]!=null&&q.open[i]!=null&&q.high[i]!=null&&q.low[i]!=null)
          candles.push({t:ts[i]*1000,o:q.open[i],h:q.high[i],l:q.low[i],c:q.close[i]});
      }
      if(candles.length<50){lastErr=`Données insuffisantes (${candles.length} bougies)`;continue;}
      return candles;
    }catch(e){
      lastErr=e.name==='AbortError'?'Délai dépassé — serveur trop lent':e.message;
    }
  }
  throw new Error(lastErr);
}

// ═══════════════════════════════════════════════════════
// INDICATEURS TECHNIQUES
// ═══════════════════════════════════════════════════════
function sma(arr,n){const r=new Array(arr.length).fill(null);for(let i=n-1;i<arr.length;i++){let s=0;for(let j=0;j<n;j++)s+=arr[i-j];r[i]=s/n;}return r;}
function ema(arr,n){const k=2/(n+1),r=new Array(arr.length).fill(null);let s=0;for(let i=0;i<n;i++)s+=arr[i];r[n-1]=s/n;for(let i=n;i<arr.length;i++)r[i]=arr[i]*k+r[i-1]*(1-k);return r;}
function calcRSI(closes,n=14){const r=new Array(closes.length).fill(null);if(closes.length<n+1)return r;let aG=0,aL=0;for(let i=1;i<=n;i++){const d=closes[i]-closes[i-1];if(d>0)aG+=d;else aL-=d;}aG/=n;aL/=n;r[n]=aL===0?100:100-100/(1+aG/aL);for(let i=n+1;i<closes.length;i++){const d=closes[i]-closes[i-1];aG=(aG*(n-1)+Math.max(0,d))/n;aL=(aL*(n-1)+Math.max(0,-d))/n;r[i]=aL===0?100:100-100/(1+aG/aL);}return r;}
function calcMACD(closes,fast=12,slow=26,sig=9){const eF=ema(closes,fast),eS=ema(closes,slow);const ml=closes.map((_,i)=>eF[i]!=null&&eS[i]!=null?eF[i]-eS[i]:null);const sl=new Array(closes.length).fill(null);const fi=ml.findIndex(v=>v!=null);if(fi>=0&&fi+sig<closes.length){let s=0;for(let i=fi;i<fi+sig;i++)s+=ml[i];sl[fi+sig-1]=s/sig;const k=2/(sig+1);for(let i=fi+sig;i<closes.length;i++)sl[i]=ml[i]*k+sl[i-1]*(1-k);}const hist=closes.map((_,i)=>ml[i]!=null&&sl[i]!=null?ml[i]-sl[i]:null);return{ml,sl,hist};}
function calcATR(highs,lows,closes,n=14){const r=new Array(closes.length).fill(null),tr=new Array(closes.length).fill(null);for(let i=1;i<closes.length;i++)tr[i]=Math.max(highs[i]-lows[i],Math.abs(highs[i]-closes[i-1]),Math.abs(lows[i]-closes[i-1]));let s=0;for(let i=1;i<=n;i++)s+=tr[i];r[n]=s/n;for(let i=n+1;i<closes.length;i++)r[i]=(r[i-1]*(n-1)+tr[i])/n;return r;}

// ═══════════════════════════════════════════════════════
// DÉTECTION REVERSAL PATTERNS (BRAIN.md §4)
// ═══════════════════════════════════════════════════════
function detectReversalPatterns(candles){
  const n=candles.length;if(n<3)return[];
  const c0=candles[n-1],c1=candles[n-2],c2=candles[n-3];
  const body=c=>Math.abs(c.c-c.o);
  const up=c=>c.h-Math.max(c.o,c.c);
  const dn=c=>Math.min(c.o,c.c)-c.l;
  const rng=c=>c.h-c.l;
  const bull=c=>c.c>c.o;
  const bear=c=>c.c<c.o;
  const doji=c=>body(c)<=rng(c)*0.1;
  const mid=c=>(c.o+c.c)/2;
  const p=[];

  // ── BULLISH ──
  // Hammer
  const b0=body(c0),u0=up(c0),d0=dn(c0),r0=rng(c0);
  if(b0>0&&d0>=2*b0&&u0<=b0*0.3&&Math.min(c0.o,c0.c)>c0.l+r0*0.5)
    p.push({name:'Hammer',dir:'bull',strength:'moderate'});
  // Inverted Hammer
  if(b0>0&&u0>=2*b0&&d0<=b0*0.3&&Math.max(c0.o,c0.c)<c0.h-r0*0.5)
    p.push({name:'Inverted Hammer',dir:'bull',strength:'weak'});
  // Bullish Engulfing
  if(bull(c0)&&bear(c1)&&c0.o<=c1.c&&c0.c>=c1.o&&body(c0)>body(c1))
    p.push({name:'Engulfing Haussier',dir:'bull',strength:'moderate'});
  // Shooting Star
  if(b0>0&&u0>=2*b0&&d0<=b0*0.3&&Math.max(c0.o,c0.c)<c0.h-r0*0.5)
    p.push({name:'Shooting Star',dir:'bear',strength:'moderate'});
  // Hanging Man (same shape as hammer but bearish context)
  if(b0>0&&d0>=2*b0&&u0<=b0*0.3&&bull(c1)&&bull(c2))
    p.push({name:'Hanging Man',dir:'bear',strength:'moderate'});
  // Bearish Engulfing
  if(bear(c0)&&bull(c1)&&c0.o>=c1.c&&c0.c<=c1.o&&body(c0)>body(c1))
    p.push({name:'Engulfing Baissier',dir:'bear',strength:'moderate'});
  // Dragonfly Doji
  if(doji(c0)&&d0>=r0*0.6&&u0<=r0*0.1)
    p.push({name:'Dragonfly Doji',dir:'bull',strength:'moderate'});
  // Gravestone Doji
  if(doji(c0)&&u0>=r0*0.6&&d0<=r0*0.1)
    p.push({name:'Gravestone Doji',dir:'bear',strength:'moderate'});
  // Piercing Line
  if(bear(c1)&&bull(c0)&&c0.o<c1.l&&c0.c>mid(c1)&&c0.c<c1.o)
    p.push({name:'Piercing Line',dir:'bull',strength:'moderate'});
  // Dark Cloud Cover
  if(bull(c1)&&bear(c0)&&c0.o>c1.h&&c0.c<mid(c1)&&c0.c>c1.o)
    p.push({name:'Dark Cloud Cover',dir:'bear',strength:'high'});
  // Morning Star
  if(bear(c2)&&body(c2)>rng(c2)*0.5&&body(c1)<rng(c1)*0.35&&bull(c0)&&body(c0)>rng(c0)*0.5&&c0.c>mid(c2))
    p.push({name:'Morning Star',dir:'bull',strength:'moderate'});
  // Evening Star
  if(bull(c2)&&body(c2)>rng(c2)*0.5&&body(c1)<rng(c1)*0.35&&bear(c0)&&body(c0)>rng(c0)*0.5&&c0.c<mid(c2))
    p.push({name:'Evening Star',dir:'bear',strength:'high'});
  // Three White Soldiers
  if(bull(c0)&&bull(c1)&&bull(c2)&&c0.c>c1.c&&c1.c>c2.c&&c0.o>c1.o&&c1.o>c2.o)
    p.push({name:'Three White Soldiers',dir:'bull',strength:'high'});
  // Three Black Crows
  if(bear(c0)&&bear(c1)&&bear(c2)&&c0.c<c1.c&&c1.c<c2.c&&c0.o<c1.o&&c1.o<c2.o)
    p.push({name:'Three Black Crows',dir:'bear',strength:'high'});
  // Three Inside Up
  if(bear(c2)&&bull(c1)&&c1.o>=c2.c&&c1.c<=c2.o&&bull(c0)&&c0.c>c2.o)
    p.push({name:'Three Inside Up',dir:'bull',strength:'high'});
  // Three Inside Down
  if(bull(c2)&&bear(c1)&&c1.o<=c2.c&&c1.c>=c2.o&&bear(c0)&&c0.c<c2.o)
    p.push({name:'Three Inside Down',dir:'bear',strength:'high'});
  // Harami Bullish
  if(bear(c1)&&bull(c0)&&c0.o>c1.c&&c0.c<c1.o&&body(c0)<body(c1)*0.5)
    p.push({name:'Harami Haussier',dir:'bull',strength:'weak'});
  // Harami Bearish
  if(bull(c1)&&bear(c0)&&c0.o<c1.c&&c0.c>c1.o&&body(c0)<body(c1)*0.5)
    p.push({name:'Harami Baissier',dir:'bear',strength:'weak'});

  return p;
}

// ═══════════════════════════════════════════════════════
// NIVEAUX CLÉS SUPPORT/RÉSISTANCE (BRAIN.md §5 — Extreme Money)
// ═══════════════════════════════════════════════════════
function detectKeyLevels(candles){
  const n=candles.length;if(n<5)return null;
  const last=candles[n-1];
  const levels=[];

  // Regrouper les bougies par semaine et par mois
  const getWeek=ts=>{const d=new Date(ts);d.setHours(0,0,0,0);d.setDate(d.getDate()-d.getDay());return d.getTime();}
  const getMonth=ts=>{const d=new Date(ts);return new Date(d.getFullYear(),d.getMonth(),1).getTime();}

  const weeks={},months={};
  candles.forEach(c=>{
    const wk=getWeek(c.t);if(!weeks[wk])weeks[wk]={open:c.o,high:c.h,low:c.l};
    else{weeks[wk].high=Math.max(weeks[wk].high,c.h);weeks[wk].low=Math.min(weeks[wk].low,c.l);}
    const mo=getMonth(c.t);if(!months[mo])months[mo]={open:c.o,high:c.h,low:c.l};
    else{months[mo].high=Math.max(months[mo].high,c.h);months[mo].low=Math.min(months[mo].low,c.l);}
  });

  const wkKeys=Object.keys(weeks).map(Number).sort((a,b)=>b-a);
  const moKeys=Object.keys(months).map(Number).sort((a,b)=>b-a);

  if(wkKeys.length>=1){const w=weeks[wkKeys[0]];levels.push({label:'Weekly Open',price:w.open,type:'WO'});levels.push({label:'Weekly High',price:w.high,type:'WH'});levels.push({label:'Weekly Low',price:w.low,type:'WL'});}
  if(wkKeys.length>=2){const w=weeks[wkKeys[1]];levels.push({label:'Prev Week High',price:w.high,type:'PWH'});levels.push({label:'Prev Week Low',price:w.low,type:'PWL'});}
  if(moKeys.length>=1){const m=months[moKeys[0]];levels.push({label:'Monthly Open',price:m.open,type:'MO'});levels.push({label:'Monthly High',price:m.high,type:'MH'});levels.push({label:'Monthly Low',price:m.low,type:'ML'});}
  if(moKeys.length>=2){const m=months[moKeys[1]];levels.push({label:'Prev Month High',price:m.high,type:'PMH'});levels.push({label:'Prev Month Low',price:m.low,type:'PML'});}

  // Trouver les niveaux proches du prix actuel (±1% ou ±ATR)
  const price=last.c;
  const near=levels.filter(l=>Math.abs(l.price-price)/price<0.012).sort((a,b)=>Math.abs(a.price-price)-Math.abs(b.price-price));
  return{all:levels,near,price};
}

// ═══════════════════════════════════════════════════════
// CERVEAU DU TRADER
// ═══════════════════════════════════════════════════════
function traderBrain(symbol,candles,capital,riskPct){
  const info=PAIR_INFO[symbol]||{pipMult:10000,pipVal:8.5,dec:5};
  const closes=candles.map(c=>c.c),highs=candles.map(c=>c.h),lows=candles.map(c=>c.l);
  const n=closes.length;
  const ma20a=sma(closes,20),ma50a=sma(closes,50),ma200a=sma(closes,200);
  const rsiA=calcRSI(closes,14);
  const{ml:macdL,sl:macdS,hist:macdH}=calcMACD(closes);
  const atrA=calcATR(highs,lows,closes,14);
  const price=closes[n-1],ma20=ma20a[n-1],ma50=ma50a[n-1],ma200=ma200a[n-1];
  const rsiV=rsiA[n-1],macdV=macdL[n-1],macdSV=macdS[n-1],macdHV=macdH[n-1],atrV=atrA[n-1];
  const patterns=detectReversalPatterns(candles);
  const keyLvl=detectKeyLevels(candles);
  if(!ma200||!rsiV||!macdV||!atrV)
    return{signal:'ATTENDRE',score:0,reasons:['Données insuffisantes (200 bougies minimum)'],warnings:[],price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt:null,patterns,keyLvl};
  const ma20slice=ma20a.slice(Math.max(0,n-5)).filter(v=>v!=null);
  const slopeMa20=ma20slice.length>=2?(ma20slice[ma20slice.length-1]-ma20slice[0])/ma20slice[0]*100:0;
  let direction;
  if(ma20>ma50&&slopeMa20>0)direction='HAUSSE';
  else if(ma20<ma50&&slopeMa20<0)direction='BAISSE';
  else direction='NEUTRE';
  let score=0;const reasons=[],warnings=[];
  if(direction==='HAUSSE'){
    score+=25;reasons.push('Tendance haussière confirmée — MA20 > MA50');
    if(ma50<ma200)warnings.push('MA50 sous MA200 — tendance de fond baissière');
    else{score+=15;reasons.push('Tendance long terme haussière — MA50 > MA200');}
    if(slopeMa20>0.05){score+=10;reasons.push('Pente MA20 positive — accélération haussière');}
  }else if(direction==='BAISSE'){
    score+=25;reasons.push('Tendance baissière confirmée — MA20 < MA50');
    if(ma50>ma200)warnings.push('MA50 au-dessus MA200 — tendance de fond haussière');
    else{score+=15;reasons.push('Tendance long terme baissière — MA50 < MA200');}
    if(slopeMa20<-0.05){score+=10;reasons.push('Pente MA20 négative — accélération baissière');}
  }else warnings.push('Tendance neutre — pas de direction claire');
  if(direction==='HAUSSE'){
    if(rsiV>=45&&rsiV<=60){score+=20;reasons.push(`RSI favorable achat (${rsiV.toFixed(1)})`);}
    else if(rsiV<=30){score+=15;reasons.push(`RSI en survente (${rsiV.toFixed(1)}) — rebond possible`);}
    else if(rsiV>=70){score-=10;warnings.push(`RSI en surachat (${rsiV.toFixed(1)}) — risque de correction`);}
  }else if(direction==='BAISSE'){
    if(rsiV>=40&&rsiV<=55){score+=20;reasons.push(`RSI favorable vente (${rsiV.toFixed(1)})`);}
    else if(rsiV>=70){score+=15;reasons.push(`RSI en surachat (${rsiV.toFixed(1)}) — baisse possible`);}
    else if(rsiV<=30){score-=10;warnings.push(`RSI en survente (${rsiV.toFixed(1)}) — risque de rebond`);}
  }
  const macdBull=macdV>macdSV&&macdHV>0,macdBear=macdV<macdSV&&macdHV<0;
  if(direction==='HAUSSE'&&macdBull){score+=20;reasons.push('MACD haussier — momentum confirmé');}
  else if(direction==='BAISSE'&&macdBear){score+=20;reasons.push('MACD baissier — momentum confirmé');}
  else warnings.push('MACD non aligné avec la tendance');
  if(direction==='HAUSSE'&&price>ma50){score+=10;reasons.push('Prix au-dessus MA50 — zone haussière');}
  else if(direction==='BAISSE'&&price<ma50){score+=10;reasons.push('Prix sous MA50 — zone baissière');}

  // ── Reversal Patterns (BRAIN.md §4)
  const bullPat=patterns.filter(p=>p.dir==='bull');
  const bearPat=patterns.filter(p=>p.dir==='bear');
  if(direction==='HAUSSE'){
    bullPat.forEach(p=>{
      const bonus=p.strength==='high'?20:p.strength==='moderate'?10:5;
      score+=bonus;reasons.push(`Pattern haussier détecté : ${p.name} (${p.strength==='high'?'haute':p.strength==='moderate'?'moyenne':'faible'} fiabilité)`);
    });
    bearPat.forEach(p=>{
      if(p.strength==='high'){score-=10;warnings.push(`Pattern baissier contraire : ${p.name} — prudence`);}
    });
  }else if(direction==='BAISSE'){
    bearPat.forEach(p=>{
      const bonus=p.strength==='high'?20:p.strength==='moderate'?10:5;
      score+=bonus;reasons.push(`Pattern baissier détecté : ${p.name} (${p.strength==='high'?'haute':p.strength==='moderate'?'moyenne':'faible'} fiabilité)`);
    });
    bullPat.forEach(p=>{
      if(p.strength==='high'){score-=10;warnings.push(`Pattern haussier contraire : ${p.name} — prudence`);}
    });
  }

  // ── Niveaux clés (BRAIN.md §5 — Extreme Money)
  if(keyLvl?.near?.length>0){
    const nearest=keyLvl.near[0];
    const isSupport=nearest.price<price;
    if(direction==='HAUSSE'&&isSupport){score+=10;reasons.push(`Prix sur support clé : ${nearest.label} (${nearest.price.toFixed(info.dec)})`);}
    else if(direction==='BAISSE'&&!isSupport){score+=10;reasons.push(`Prix sur résistance clé : ${nearest.label} (${nearest.price.toFixed(info.dec)})`);}
    else{warnings.push(`Niveau clé proche : ${nearest.label} (${nearest.price.toFixed(info.dec)}) — surveiller`);}
  }

  score=Math.max(0,Math.min(100,score));
  let signal;
  if(score>=60&&direction==='HAUSSE')signal='ACHAT';
  else if(score>=60&&direction==='BAISSE')signal='VENTE';
  else{signal='ATTENDRE';reasons.push(`Score insuffisant (${score}/100)`);}
  let riskMgmt=null;
  if(signal!=='ATTENDRE'){
    const slDist=atrV*1.5,tp1Dist=atrV*2.5,tp2Dist=atrV*4.0;
    const sl=signal==='ACHAT'?price-slDist:price+slDist;
    const tp1=signal==='ACHAT'?price+tp1Dist:price-tp1Dist;
    const tp2=signal==='ACHAT'?price+tp2Dist:price-tp2Dist;
    const slPips=Math.abs(price-sl)*info.pipMult;
    const tp1Pips=Math.abs(price-tp1)*info.pipMult;
    const tp2Pips=Math.abs(price-tp2)*info.pipMult;
    const rr=tp1Pips/slPips;
    if(rr<2.0){warnings.push(`Ratio R/R insuffisant (1:${rr.toFixed(1)}) — minimum 1:2`);signal='ATTENDRE';}
    else{
      const riskEur=capital*riskPct/100;
      const lots=Math.floor((riskEur/(slPips*info.pipVal))*100)/100;
      const realRisk=slPips*info.pipVal*lots;
      riskMgmt={
        entry:price.toFixed(info.dec),sl:sl.toFixed(info.dec),
        tp1:tp1.toFixed(info.dec),tp2:tp2.toFixed(info.dec),
        slPips:slPips.toFixed(1),tp1Pips:tp1Pips.toFixed(1),tp2Pips:tp2Pips.toFixed(1),
        lots:lots.toFixed(2),rr:rr.toFixed(2),
        riskEur:realRisk.toFixed(2),
        profit1:(tp1Pips*info.pipVal*lots).toFixed(2),
        profit2:(tp2Pips*info.pipVal*lots).toFixed(2),
      };
    }
  }
  const conseil=CONSEILS[signal][Math.floor(Math.random()*3)];
  return{signal,score,direction,slopeMa20,price,ma20,ma50,ma200,rsiV,macdV,macdSV,macdHV,atrV,riskMgmt,reasons,warnings,conseil,patterns,keyLvl};
}

// ═══════════════════════════════════════════════════════
// RENDER RESULT (ANALYSER)
// ═══════════════════════════════════════════════════════
function renderResult(res,symbol){
  const info=PAIR_INFO[symbol]||{name:symbol,dec:5};
  const d=info.dec;
  const sigCls=res.signal==='ACHAT'?'buy':res.signal==='VENTE'?'sell':'wait';
  const sigLbl=res.signal==='ACHAT'?'▲ ACHAT':res.signal==='VENTE'?'▼ VENTE':'◆ ATTENDRE';
  const barFillCls=res.signal==='ACHAT'?'fill-buy':res.signal==='VENTE'?'fill-sell':'fill-wait';
  const forceLabel=res.score>=80?'FORT':res.score>=60?'MOYEN':'FAIBLE';
  const dirColor=res.direction==='HAUSSE'?'var(--buy)':res.direction==='BAISSE'?'var(--sell)':'var(--dim)';
  const dirStr=res.direction==='HAUSSE'?'▲ HAUSSE':res.direction==='BAISSE'?'▼ BAISSE':'— NEUTRE';
  const macdIsBull=res.macdV>res.macdSV&&res.macdHV>0,macdIsBear=res.macdV<res.macdSV&&res.macdHV<0;
  const macdSig=macdIsBull?'HAUSSIER':macdIsBear?'BAISSIER':'NEUTRE';
  const macdColor=macdIsBull?'var(--buy)':macdIsBear?'var(--sell)':'var(--dim)';
  const planBorder=res.signal==='ACHAT'?'var(--buy)':res.signal==='VENTE'?'var(--sell)':'var(--b2)';
  const adviceBorder=res.signal==='ACHAT'?'var(--buy)':res.signal==='VENTE'?'var(--sell)':'var(--b3)';
  const now=new Date().toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});

  // ── Verdict résumé
  const verdictColor=res.signal==='ACHAT'?'var(--buy)':res.signal==='VENTE'?'var(--sell)':'var(--dim)';
  const topPattern=res.patterns?.filter(p=>p.strength!=='weak'&&((res.signal==='ACHAT'&&p.dir==='bull')||(res.signal==='VENTE'&&p.dir==='bear')))[0];
  const topLevel=res.keyLvl?.near?.[0];
  const verdictParts=[];
  if(res.direction!=='NEUTRE')verdictParts.push(res.direction==='HAUSSE'?'Tendance haussière':'Tendance baissière');
  if(topPattern)verdictParts.push(topPattern.name);
  if(topLevel)verdictParts.push(topLevel.label);
  const verdictSummary=verdictParts.length?verdictParts.join(' · '):'Aucune confluence — attendre';

  let h='<div class="result">';
  h+=`<div style="border-left:3px solid ${verdictColor};padding:10px 14px;background:var(--s1);margin-bottom:16px;border-radius:2px">
    <div style="font-family:var(--mono);font-size:.56rem;letter-spacing:.14em;color:var(--dim);text-transform:uppercase;margin-bottom:4px">Verdict</div>
    <div style="font-family:var(--mono);font-size:1rem;font-weight:600;color:${verdictColor};margin-bottom:3px">${res.signal==='ACHAT'?'▲ ACHETER':res.signal==='VENTE'?'▼ VENDRE':'◆ ATTENDRE'}</div>
    <div style="font-size:.75rem;color:var(--body);line-height:1.5">${verdictSummary}</div>
  </div>`;

  h+=`
  <div class="sig-block">
    <div class="sig-pair">${info.name} &nbsp;·&nbsp; ${state.tf.toUpperCase()} &nbsp;·&nbsp; ${now}</div>
    <div class="sig-main-row">
      <div class="sig-val ${sigCls}">${sigLbl}</div>
      <div class="sig-score-wrap">
        <div class="sig-score-txt">Confiance &nbsp;${res.score}/100</div>
        <div class="sig-bar"><div class="sig-bar-fill ${barFillCls}" style="width:${res.score}%"></div></div>
        <div class="sig-force">Force &nbsp;${forceLabel}</div>
      </div>
    </div>
  </div>`;

  h+=`
  <table class="data-table">
    <tr><td>Prix</td><td class="v-w">${res.price?.toFixed(d)}</td></tr>
    <tr><td>Tendance</td><td style="color:${dirColor};font-weight:600">${dirStr}</td></tr>
    <tr><td>MA20</td><td>${res.ma20?.toFixed(d)}</td></tr>
    <tr><td>MA50</td><td>${res.ma50?.toFixed(d)}</td></tr>
    <tr><td>MA200</td><td class="v-g">${res.ma200?.toFixed(d)}</td></tr>
    <tr><td>RSI 14</td><td class="${res.rsiV>=70||res.rsiV<=30?'v-w':'v-g'}">${res.rsiV?.toFixed(1)}&nbsp;&nbsp;<span style="font-size:.65rem;color:var(--dim)">${res.rsiV>=70?'surachat':res.rsiV<=30?'survente':''}</span></td></tr>
    <tr><td>MACD</td><td style="color:${macdColor};font-weight:${macdSig!=='NEUTRE'?'600':'400'}">${macdSig}</td></tr>
    <tr><td>ATR</td><td class="v-d">${res.atrV?.toFixed(d)}</td></tr>
  </table>`;

  if(res.riskMgmt){
    const rm=res.riskMgmt;
    h+=`
  <div class="plan-block" style="border-color:${planBorder}">
    <div class="plan-hdr">
      <div>
        <div class="plan-lot-num">${rm.lots}</div>
        <div class="plan-lot-label">Lots recommandés &nbsp;·&nbsp; ${rm.riskEur} €</div>
      </div>
      <div class="plan-rr">R/R &nbsp;1:${rm.rr}</div>
    </div>
    <div class="level-row">
      <span class="level-tag">Entrée</span>
      <span class="level-price" style="color:var(--white)">${rm.entry}</span>
      <span class="level-info">—</span>
    </div>
    <div class="level-row">
      <span class="level-tag">Stop Loss</span>
      <span class="level-price" style="color:var(--sell)">${rm.sl}</span>
      <span class="level-info">${rm.slPips} pips</span>
    </div>
    <div class="level-row">
      <span class="level-tag">TP 1</span>
      <span class="level-price" style="color:var(--buy)">${rm.tp1}</span>
      <span class="level-info" style="color:var(--buy)">+${rm.profit1} € &nbsp;${rm.tp1Pips}p</span>
    </div>
    <div class="level-row">
      <span class="level-tag">TP 2</span>
      <span class="level-price" style="color:var(--buy)">${rm.tp2}</span>
      <span class="level-info" style="color:var(--buy)">+${rm.profit2} € &nbsp;${rm.tp2Pips}p</span>
    </div>
  </div>`;
  }

  if(res.reasons?.length){
    h+=`<div class="log-block"><div class="log-title">Raisons</div>`;
    res.reasons.forEach(r=>{h+=`<div class="log-item ok">${r}</div>`;});
    h+=`</div>`;
  }
  if(res.warnings?.length){
    h+=`<div class="log-block"><div class="log-title">Avertissements</div>`;
    res.warnings.forEach(w=>{h+=`<div class="log-item warn">${w}</div>`;});
    h+=`</div>`;
  }
  // ── Reversal Patterns
  if(res.patterns?.length){
    h+=`<div class="log-block"><div class="log-title">Patterns de retournement détectés</div>`;
    res.patterns.forEach(p=>{
      const isAligned=(res.signal==='ACHAT'&&p.dir==='bull')||(res.signal==='VENTE'&&p.dir==='bear');
      const color=isAligned?(p.strength==='high'?'var(--buy)':'var(--body)'):(p.strength==='high'?'var(--sell)':'var(--dim)');
      const icon=p.dir==='bull'?'▲':'▼';
      const tag=p.strength==='high'?'★★':p.strength==='moderate'?'★':'·';
      h+=`<div class="log-item" style="color:${color}">${icon} ${p.name} <span style="color:var(--dim);font-size:.65rem">${tag}</span></div>`;
    });
    h+=`</div>`;
  }

  // ── Niveaux clés support/résistance
  if(res.keyLvl?.near?.length){
    h+=`<div class="log-block"><div class="log-title">Niveaux clés proches (Extreme Money)</div>`;
    res.keyLvl.near.forEach(l=>{
      const isBelow=l.price<res.price;
      const typeColor=isBelow?'var(--buy)':'var(--sell)';
      const typeLabel=isBelow?'Support':'Résistance';
      h+=`<div class="log-item" style="display:flex;justify-content:space-between"><span style="color:${typeColor}">${l.label}</span><span style="font-family:var(--mono);color:var(--main)">${l.price.toFixed(d)} <span style="font-size:.6rem;color:var(--dim)">${typeLabel}</span></span></div>`;
    });
    h+=`</div>`;
  }

  if(res.conseil){
    h+=`<div class="advice" style="border-left-color:${adviceBorder}"><div class="advice-tag">Trader Pro</div><div class="advice-txt">${res.conseil}</div></div>`;
  }
  h+='</div>';
  return h;
}

// ═══════════════════════════════════════════════════════
// RUN ANALYSIS
// ═══════════════════════════════════════════════════════
async function runAnalysis(){
  const symbol=document.getElementById('pairSelect').value;
  const capital=parseFloat(document.getElementById('capitalInput').value)||1000;
  const btn=document.getElementById('btnAnalyse');
  const out=document.getElementById('analysisResult');
  btn.disabled=true;
  out.innerHTML=`<div class="loading"><div class="loading-row"><div class="sp"></div>Connexion au marché…</div></div>`;
  try{
    const range=RANGE_MAP[state.tf]||'1y';
    const candles=await fetchCandles(symbol,state.tf,range);
    out.querySelector('.loading').innerHTML='<div class="loading-row"><div class="sp"></div>Calcul des indicateurs…</div>';
    const result=traderBrain(symbol,candles,capital,state.riskPct);
    out.innerHTML=renderResult(result,symbol);
  }catch(e){
    out.innerHTML=`<div class="err"><strong>Erreur de connexion</strong><br>${e.message}<br><br>Si le problème persiste, réessaie dans quelques secondes.</div>`;
  }finally{btn.disabled=false;}
}

// ═══════════════════════════════════════════════════════
// RUN SCAN
// ═══════════════════════════════════════════════════════
async function runScan(){
  const btn=document.getElementById('btnScan');
  const out=document.getElementById('scanResult');
  btn.disabled=true;
  const total=FOREX_SCAN_PAIRS.length;
  out.innerHTML=`<div class="scan-prog"><div class="scan-prog-label" id="pgLabel">Initialisation…</div><div class="scan-prog-bar-bg"><div class="scan-prog-bar-fill" id="pgBar" style="width:0%"></div></div></div>`;
  const results=[];
  for(let i=0;i<FOREX_SCAN_PAIRS.length;i++){
    const sym=FOREX_SCAN_PAIRS[i];
    document.getElementById('pgLabel').textContent=`${i+1} / ${total} — ${PAIR_INFO[sym]?.name||sym}`;
    document.getElementById('pgBar').style.width=Math.round((i+1)/total*100)+'%';
    try{
      const range=RANGE_MAP[state.scanTf]||'1y';
      const candles=await fetchCandles(sym,state.scanTf,range);
      const res=traderBrain(sym,candles,1000,2);
      results.push({sym,res});
    }catch(e){results.push({sym,res:null,err:e.message});}
    if(i<FOREX_SCAN_PAIRS.length-1)await delay(700);
  }
  results.sort((a,b)=>{
    const ord={ACHAT:0,VENTE:1,ATTENDRE:2};
    const sa=a.res?.signal||'ATTENDRE',sb=b.res?.signal||'ATTENDRE';
    if(ord[sa]!==ord[sb])return ord[sa]-ord[sb];
    return(b.res?.score||0)-(a.res?.score||0);
  });
  const nb_a=results.filter(r=>r.res?.signal==='ACHAT').length;
  const nb_v=results.filter(r=>r.res?.signal==='VENTE').length;
  const nb_w=results.filter(r=>r.res?.signal==='ATTENDRE'||!r.res).length;
  let html=`
  <div class="scan-sum">
    <div class="scan-sum-cell"><div class="scan-sum-num" style="color:var(--buy)">${nb_a}</div><div class="scan-sum-label">Achat</div></div>
    <div class="scan-sum-cell"><div class="scan-sum-num" style="color:var(--sell)">${nb_v}</div><div class="scan-sum-label">Vente</div></div>
    <div class="scan-sum-cell"><div class="scan-sum-num" style="color:var(--dim)">${nb_w}</div><div class="scan-sum-label">Attendre</div></div>
  </div>
  <div class="scan-tbl-wrap"><table>
    <thead><tr><th>Paire</th><th>Signal</th><th>Score</th><th>Dir.</th><th>RSI</th></tr></thead>
    <tbody>`;
  results.forEach(({sym,res,err})=>{
    const info=PAIR_INFO[sym]||{name:sym};
    if(!res){html+=`<tr class="r-w"><td>${info.name}</td><td colspan="4" style="color:var(--dim);font-size:.65rem">${err||'Err'}</td></tr>`;return;}
    const sigStr=res.signal==='ACHAT'?`<span style="color:var(--buy);font-weight:600">▲ ACHAT</span>`:res.signal==='VENTE'?`<span style="color:var(--sell);font-weight:600">▼ VENTE</span>`:`<span style="color:var(--dim)">◆</span>`;
    const dirStr=res.direction==='HAUSSE'?`<span style="color:var(--buy)">▲</span>`:res.direction==='BAISSE'?`<span style="color:var(--sell)">▼</span>`:`<span style="color:var(--dim)">—</span>`;
    const rowCls=res.signal==='ACHAT'?'r-b':res.signal==='VENTE'?'r-s':'r-w';
    const sc=res.signal==='ACHAT'?'var(--buy)':res.signal==='VENTE'?'var(--sell)':res.score>=50?'var(--mid)':'var(--dim)';
    html+=`<tr class="${rowCls}"><td style="font-weight:600;color:var(--main)">${info.name}</td><td>${sigStr}</td><td style="color:${sc};font-weight:600">${res.score}</td><td>${dirStr}</td><td style="color:var(--mid)">${res.rsiV?.toFixed(1)??'—'}</td></tr>`;
  });
  html+=`</tbody></table></div>`;
  out.innerHTML=html;
  btn.disabled=false;
}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

// ═══════════════════════════════════════════════════════
// CALCULATEUR FOREX — DONNÉES
// ═══════════════════════════════════════════════════════
const CC_PIP_DATA = {
  EURUSD:{pipVal:8.50,type:'Majeure',vol:'Modérée',spread:'0.5-1.5'},
  GBPUSD:{pipVal:8.50,type:'Majeure',vol:'Haute',spread:'1.0-2.5'},
  USDJPY:{pipVal:5.65,type:'Majeure',vol:'Modérée',spread:'0.5-1.5'},
  USDCHF:{pipVal:7.90,type:'Majeure',vol:'Modérée',spread:'1.0-2.5'},
  AUDUSD:{pipVal:8.50,type:'Majeure',vol:'Modérée',spread:'0.8-2.0'},
  USDCAD:{pipVal:6.10,type:'Majeure',vol:'Modérée',spread:'1.5-3.0'},
  NZDUSD:{pipVal:8.50,type:'Majeure',vol:'Modérée',spread:'1.5-3.0'},
  EURGBP:{pipVal:11.05,type:'Mineure',vol:'Faible',spread:'1.5-2.5'},
  EURJPY:{pipVal:5.50,type:'Mineure',vol:'Haute',spread:'1.5-2.5'},
  EURCHF:{pipVal:8.50,type:'Mineure',vol:'Faible',spread:'2.0-4.0'},
  EURAUD:{pipVal:6.00,type:'Mineure',vol:'Haute',spread:'2.0-4.0'},
  EURCAD:{pipVal:6.00,type:'Mineure',vol:'Modérée',spread:'2.5-4.5'},
  EURNZD:{pipVal:5.30,type:'Mineure',vol:'Haute',spread:'3.0-6.0'},
  GBPJPY:{pipVal:5.50,type:'Mineure',vol:'Très haute',spread:'2.0-4.0'},
  GBPCHF:{pipVal:8.60,type:'Mineure',vol:'Haute',spread:'2.5-5.0'},
  GBPAUD:{pipVal:5.95,type:'Mineure',vol:'Très haute',spread:'2.5-5.0'},
  GBPCAD:{pipVal:5.95,type:'Mineure',vol:'Haute',spread:'3.0-6.0'},
  GBPNZD:{pipVal:5.30,type:'Mineure',vol:'Très haute',spread:'4.0-8.0'},
  AUDJPY:{pipVal:5.50,type:'Mineure',vol:'Haute',spread:'2.0-4.0'},
  AUDCHF:{pipVal:8.50,type:'Mineure',vol:'Modérée',spread:'2.0-4.0'},
  AUDCAD:{pipVal:6.10,type:'Mineure',vol:'Modérée',spread:'3.0-5.0'},
  AUDNZD:{pipVal:5.95,type:'Mineure',vol:'Modérée',spread:'3.0-6.0'},
  CADJPY:{pipVal:5.65,type:'Mineure',vol:'Modérée',spread:'2.0-4.0'},
  CHFJPY:{pipVal:5.65,type:'Mineure',vol:'Modérée',spread:'2.0-4.0'},
  NZDJPY:{pipVal:5.50,type:'Mineure',vol:'Modérée',spread:'2.5-5.0'},
  NZDCHF:{pipVal:8.50,type:'Mineure',vol:'Modérée',spread:'3.0-6.0'},
  NZDCAD:{pipVal:6.10,type:'Mineure',vol:'Modérée',spread:'3.0-6.0'},
  CADCHF:{pipVal:8.00,type:'Mineure',vol:'Faible',spread:'3.0-6.0'},
  XAUUSD:{pipVal:0.93,type:'Commodité',vol:'Haute',spread:'0.3-0.6 $',note:'1 pip=0.01$ · 1lot=100oz'},
  DJ30:  {pipVal:0.93,type:'Indice CFD',vol:'Haute',spread:'2-5 pts',note:'1 pip=1pt · 1lot=1 contrat'},
};
const CC_PIP_MULT={USDJPY:100,EURJPY:100,GBPJPY:100,AUDJPY:100,CADJPY:100,CHFJPY:100,NZDJPY:100,XAUUSD:100,DJ30:1};
const CC_STEPS={USDJPY:'0.001',EURJPY:'0.001',GBPJPY:'0.001',AUDJPY:'0.001',CADJPY:'0.001',CHFJPY:'0.001',NZDJPY:'0.001',XAUUSD:'0.01',DJ30:'0.1'};
const CC_RISK_LEVELS=[1,2,3,5,10,15,20,30];

// ─── STATE CALCULATEUR ────────────────────────────────
let ccState={capital:1000,pair:'GBPUSD',direction:'BUY',entry:null,sl:null,tp1:null,tp2:null,riskPct:10};

function ccPipMult(p){return CC_PIP_MULT[p]??10000;}
function ccToPips(p,a,b){return Math.abs(a-b)*ccPipMult(p);}
function ccCalcLots(riskEur,slPips,pipVal){if(slPips<=0||pipVal<=0)return null;return Math.floor(riskEur/(slPips*pipVal)*100)/100;}
function ccFmt(n,dec=2){return n.toFixed(dec);}

function ccSetDir(dir){
  ccState.direction=dir;
  document.getElementById('cc-btnBuy').classList.toggle('active',dir==='BUY');
  document.getElementById('cc-btnSell').classList.toggle('active',dir==='SELL');
  ccCompute();
}
function ccSetRisk(pct){
  ccState.riskPct=pct;
  document.querySelectorAll('#cc-riskGrid .btn-chip').forEach(b=>b.classList.toggle('active',parseFloat(b.dataset.cr)===pct));
  ccUpdateRiskHint();
  ccCompute();
}
function ccUpdateRiskHint(){
  const e=ccState.capital*ccState.riskPct/100;
  document.getElementById('cc-riskHint').textContent=`${e>=0?'+':''}${ccFmt(e)} € risqués sur ce trade`;
}
function ccUpdatePairMeta(){
  const d=CC_PIP_DATA[ccState.pair];if(!d)return;
  const vc=d.vol==='Très haute'?'var(--sell)':d.vol==='Haute'?'#f0b429':'var(--dim)';
  const note=d.note?`<span class="pair-meta-tag" style="color:var(--mid)"><span>${d.note}</span></span>`:'';
  document.getElementById('cc-pairMeta').innerHTML=`
    <span class="pair-meta-tag"><span>${d.type}</span></span>
    <span class="pair-meta-tag">Pip: <span>${d.pipVal} €/lot</span></span>
    <span class="pair-meta-tag">Spread: <span>${d.spread}</span></span>
    <span class="pair-meta-tag" style="color:${vc}">Vol: ${d.vol}</span>
    ${note}`;
  const step=CC_STEPS[ccState.pair]||'0.00001';
  ['cc-entry','cc-sl','cc-tp1','cc-tp2'].forEach(id=>{document.getElementById(id).step=step;});
}
function ccUpdatePipHint(hintId,pips){
  const el=document.getElementById(hintId);
  if(pips!==null&&pips>0){el.textContent=`${ccFmt(pips,1)} pips de l'entrée`;el.classList.add('valid');}
  else{el.textContent='—';el.classList.remove('valid');}
}

function ccRrBadge(rr){
  const cls=rr>=1.5?'good':rr>=1.0?'ok':'bad';
  const icon=cls==='good'?'✓':cls==='ok'?'~':'✗';
  return `<div class="rr-badge ${cls}">${icon} 1:${ccFmt(rr,2)}</div>`;
}

function ccCompute(){
  const{capital,pair,riskPct,entry,sl,tp1,tp2}=ccState;
  const pipVal=CC_PIP_DATA[pair]?.pipVal;
  const riskEur=capital*riskPct/100;
  const slPips=(entry&&sl)?ccToPips(pair,entry,sl):null;
  const tp1Pips=(entry&&tp1)?ccToPips(pair,entry,tp1):null;
  const tp2Pips=(entry&&tp2)?ccToPips(pair,entry,tp2):null;
  ccUpdatePipHint('cc-slHint',slPips);
  ccUpdatePipHint('cc-tp1Hint',tp1Pips);
  ccUpdatePipHint('cc-tp2Hint',tp2Pips);

  if(!entry||!sl||!slPips||slPips<=0){
    document.getElementById('cc-result').innerHTML=`<div class="empty"><span class="empty-icon">◈</span>Entrez l'entrée et le stop loss</div>`;
    return;
  }
  const lots=ccCalcLots(riskEur,slPips,pipVal);
  if(!lots||lots<=0){
    document.getElementById('cc-result').innerHTML=`<div class="empty"><span class="empty-icon">◈</span>Capital ou risque insuffisant</div>`;
    return;
  }
  const realRisk=slPips*pipVal*lots;

  // Lot block
  let html=`<div class="calc-result-lot">
    <div>
      <div class="calc-lot-big">${ccFmt(lots,2)}</div>
      <div class="calc-lot-sub">lots &nbsp;·&nbsp; ${riskPct}% &nbsp;·&nbsp; ${ccFmt(slPips,1)} pips SL</div>
    </div>
    <div style="text-align:right">
      <div style="font-family:var(--mono);font-size:.62rem;color:var(--dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:2px">Risque</div>
      <div style="font-family:var(--mono);font-size:1.1rem;font-weight:600;color:var(--sell)">-${ccFmt(realRisk)} €</div>
    </div>
  </div>`;

  // Result grid
  html+=`<div class="calc-result-grid">
    <div class="calc-box">
      <div class="calc-box-label">SL Distance</div>
      <div class="calc-box-val">${ccFmt(slPips,1)}</div>
      <div class="calc-box-sub">pips</div>
    </div>
    <div class="calc-box">
      <div class="calc-box-label">Pip value</div>
      <div class="calc-box-val">${pipVal}</div>
      <div class="calc-box-sub">€ / lot</div>
    </div>`;

  if(tp1Pips&&tp1Pips>0){
    const profit1=tp1Pips*pipVal*lots;
    const rr1=tp1Pips/slPips;
    html+=`<div class="calc-box">
      <div class="calc-box-label">Profit TP1</div>
      <div class="calc-box-val green">+${ccFmt(profit1)} €</div>
      <div class="calc-box-sub">${ccFmt(tp1Pips,1)} pips</div>
    </div>
    <div class="calc-box">
      <div class="calc-box-label">Ratio R/R TP1</div>
      <div>${ccRrBadge(rr1)}</div>
    </div>`;
  }
  if(tp2Pips&&tp2Pips>0){
    const profit2=tp2Pips*pipVal*lots;
    const rr2=tp2Pips/slPips;
    html+=`<div class="calc-box">
      <div class="calc-box-label">Profit TP2</div>
      <div class="calc-box-val green">+${ccFmt(profit2)} €</div>
      <div class="calc-box-sub">${ccFmt(tp2Pips,1)} pips</div>
    </div>
    <div class="calc-box">
      <div class="calc-box-label">Ratio R/R TP2</div>
      <div>${ccRrBadge(rr2)}</div>
    </div>`;
  }
  html+=`</div>`;

  // Comparison table
  html+=`
  <div style="border:1px solid var(--b1);border-radius:2px;padding:12px;margin-bottom:14px">
    <div style="font-family:var(--mono);font-size:.58rem;letter-spacing:.12em;color:var(--dim);text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--b1)">Tableau comparatif — mêmes niveaux, autres risques</div>
    <div style="overflow-x:auto">
    <table class="calc-comp-table"><thead><tr><th>Risque %</th><th>Risque €</th><th>Lots</th><th>Profit TP1</th></tr></thead><tbody>`;
  CC_RISK_LEVELS.forEach(pct=>{
    const re=capital*pct/100;
    const l=ccCalcLots(re,slPips,pipVal);
    if(!l||l<=0)return;
    const rr=slPips*pipVal*l;
    const p1=tp1Pips?ccFmt(tp1Pips*pipVal*l,2)+'€':'-';
    const active=pct===riskPct?'active-row':'';
    html+=`<tr class="${active}"><td style="font-weight:700">${pct}%</td><td>${ccFmt(re)} €</td><td style="font-weight:700">${ccFmt(l,2)}</td><td style="color:var(--buy)">${tp1Pips?'+'+p1:'—'}</td></tr>`;
  });
  html+=`</tbody></table></div></div>`;

  // Règles d'or (collapsible)
  html+=`
  <div class="calc-rules">
    <button class="calc-rules-toggle" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'flex':'none';this.querySelector('.chevron').textContent=this.nextElementSibling.style.display==='none'?'▸':'▾'">
      <span>Règles d'or Money Management</span><span class="chevron">▸</span>
    </button>
    <div class="calc-rules-body" style="display:none">
      <div class="calc-rule"><span>→</span><div class="calc-rule-txt"><strong>Risque / trade :</strong> 1-2% recommandé — max absolu 5%</div></div>
      <div class="calc-rule"><span>→</span><div class="calc-rule-txt"><strong>Ratio R/R :</strong> minimum 1.5:1 — idéal 2:1 ou 3:1</div></div>
      <div class="calc-rule"><span>→</span><div class="calc-rule-txt"><strong>Stop Loss obligatoire</strong> sur chaque trade</div></div>
      <div class="calc-rule"><span>→</span><div class="calc-rule-txt"><strong>Corrélations :</strong> ne jamais ouvrir 2 trades du même groupe (EUR+GBP)</div></div>
    </div>
  </div>`;

  document.getElementById('cc-result').innerHTML=html;
}

// ─── LIVE PRICE FETCH ─────────────────────────────────
async function ccFetchLive(){
  const pair=ccState.pair;
  const btn=document.getElementById('cc-btnLive');
  const icon=document.getElementById('cc-liveIcon');
  btn.style.opacity='.5';btn.style.pointerEvents='none';
  icon.innerHTML='<span style="display:inline-block;width:10px;height:10px;border:1.5px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin .6s linear infinite"></span>';
  try{
    if(pair==='DJ30'){document.getElementById('cc-entry').placeholder='Prix manuel requis';throw new Error('DJ30 non dispo');}
    const base=pair.slice(0,3).toLowerCase(),quote=pair.slice(3).toLowerCase();
    const res=await fetch(`https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/${base}.json`);
    if(!res.ok)throw new Error('API error');
    const data=await res.json();
    const rate=data[base]?.[quote];
    if(!rate)throw new Error('Rate not found');
    const dec=pair==='XAUUSD'?2:CC_PIP_MULT[pair]===100?3:5;
    const price=parseFloat(rate.toFixed(dec));
    document.getElementById('cc-entry').value=price;
    ccState.entry=price;ccCompute();
  }catch(e){icon.textContent='✗';setTimeout(()=>{icon.textContent='⟳';},1500);}
  finally{btn.style.opacity='';btn.style.pointerEvents='';icon.textContent='⟳';}
}

// ─── EVENT LISTENERS CALCULATEUR ─────────────────────
document.getElementById('cc-capital').addEventListener('input',e=>{
  ccState.capital=parseFloat(e.target.value)||0;ccUpdateRiskHint();ccCompute();
});
document.getElementById('cc-pair').addEventListener('change',e=>{
  ccState.pair=e.target.value;ccUpdatePairMeta();
  ['cc-entry','cc-sl','cc-tp1','cc-tp2'].forEach(id=>{document.getElementById(id).value='';});
  ccState.entry=null;ccState.sl=null;ccState.tp1=null;ccState.tp2=null;
  ccCompute();
});
['cc-entry','cc-sl','cc-tp1','cc-tp2'].forEach(id=>{
  document.getElementById(id).addEventListener('input',e=>{
    const val=parseFloat(e.target.value);
    const key=id==='cc-entry'?'entry':id==='cc-sl'?'sl':id==='cc-tp1'?'tp1':'tp2';
    ccState[key]=isNaN(val)?null:val;
    ccCompute();
  });
});

// ─── INIT ─────────────────────────────────────────────
ccUpdatePairMeta();
ccUpdateRiskHint();
</script>
</body>
</html>
